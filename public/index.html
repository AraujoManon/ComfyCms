<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ComfyCMS - Créez des Sites Web Professionnels</title>
    
    <!-- Google Fonts -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Playfair+Display:wght@400;500;600;700;800;900&family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    
    <!-- Sortable.js pour le drag & drop -->
    <script src="https://cdn.jsdelivr.net/npm/sortablejs@1.15.0/Sortable.min.js"></script>
    
    <!-- Styles -->
    <style>
        /* Variables CSS - Palette ComfyClick */
        :root {
            --primary: #9b87f5;
            --primary-dark: #7e69ab;
            --primary-light: #e5deff;
            --primary-rgb: 155, 135, 245;
            --secondary: #ff8e6e;
            --secondary-light: #ffd5cc;
            --accent: #ffc85c;
            --accent-light: #fff1d7;
            --dark: #1a1f2c;
            --gray: #8e9196;
            --light-gray: #f7f5ff;
            --white: #ffffff;
            --black: #000000e6;
            --border-radius: 12px;
            --shadow: 0 10px 30px rgba(155, 135, 245, 0.15);
            --transition: all 0.3s ease;
            --gradient-primary: linear-gradient(135deg, #9b87f5 0%, #7e69ab 100%);
            --gradient-secondary: linear-gradient(135deg, #ff8e6e 0%, #ff6b8b 100%);
            --gradient-accent: linear-gradient(135deg, #ffc85c 0%, #ffaa2c 100%);
            --gradient-start: rgba(var(--primary-rgb), 0.05);
            --gradient-end: rgba(var(--primary-rgb), 0.8);
            
            /* Typographie */
            --font-primary: "Playfair Display", serif;
            --font-secondary: "Inter", -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif;
            
            /* Tailles de police */
            --text-xs: 0.75rem;
            --text-sm: 0.875rem;
            --text-base: 1rem;
            --text-lg: 1.125rem;
            --text-xl: 1.25rem;
            --text-2xl: 1.5rem;
            --text-3xl: 1.875rem;
            --text-4xl: 2.25rem;
            --text-5xl: 3rem;
            
            /* Espacements */
            --space-1: 0.25rem;
            --space-2: 0.5rem;
            --space-3: 0.75rem;
            --space-4: 1rem;
            --space-5: 1.25rem;
            --space-6: 1.5rem;
            --space-8: 2rem;
            --space-10: 2.5rem;
            --space-12: 3rem;
            --space-16: 4rem;
            
            /* Layout */
            --sidebar-width: 400px;
            --toolbar-height: 60px;
            --properties-width: 360px;
        }

        /* Reset et Base */
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: var(--font-secondary);
            font-size: var(--text-base);
            color: var(--dark);
            background: var(--light-gray);
            line-height: 1.6;
            overflow: hidden;
            -webkit-font-smoothing: antialiased;
            -moz-osx-font-smoothing: grayscale;
        }

        /* Typographie moderne */
        h1, h2, h3, h4, h5, h6 {
            font-family: var(--font-primary);
            font-weight: 700;
            line-height: 1.2;
            color: var(--dark);
        }

        h1 { font-size: var(--text-4xl); }
        h2 { font-size: var(--text-3xl); }
        h3 { font-size: var(--text-2xl); }
        h4 { font-size: var(--text-xl); }
        h5 { font-size: var(--text-lg); }
        h6 { font-size: var(--text-base); }

        p {
            color: var(--gray);
            line-height: 1.7;
        }

        /* Layout Principal */
        .app-container {
            display: flex;
            flex-direction: column;
            height: 100vh;
            background: var(--light-gray);
        }

        /* Toolbar Moderne */
        .toolbar {
            height: var(--toolbar-height);
            background: var(--white);
            border-bottom: 1px solid rgba(155, 135, 245, 0.1);
            display: flex;
            align-items: center;
            padding: 0 var(--space-6);
            gap: var(--space-6);
            box-shadow: var(--shadow);
            z-index: 100;
        }

        .toolbar-logo {
            display: flex;
            align-items: center;
            gap: var(--space-3);
            font-family: var(--font-primary);
            font-size: var(--text-xl);
            font-weight: 800;
            color: var(--primary);
        }
        
        /* Style pour le nom de projet cliquable */
        .project-name-btn {
            font-family: var(--font-secondary);
            font-size: var(--text-lg);
            font-weight: 600;
            color: var(--dark);
            cursor: pointer;
            padding: var(--space-2);
            border-radius: var(--border-radius);
            transition: var(--transition);
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
            max-width: 250px;
        }
        .project-name-btn:hover {
            background: var(--primary-light);
            color: var(--primary);
        }

        .toolbar-section {
            display: flex;
            align-items: center;
            gap: var(--space-2);
        }

        .toolbar-divider {
            width: 1px;
            height: 24px;
            background: rgba(155, 135, 245, 0.2);
        }

        /* Boutons modernes */
        .btn {
            padding: var(--space-2) var(--space-4);
            border: none;
            border-radius: var(--border-radius);
            font-size: var(--text-sm);
            font-weight: 500;
            cursor: pointer;
            transition: var(--transition);
            display: inline-flex;
            align-items: center;
            gap: var(--space-2);
            font-family: var(--font-secondary);
            line-height: 1;
            position: relative;
            overflow: hidden;
        }

        .btn::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: linear-gradient(45deg, transparent 30%, rgba(255, 255, 255, 0.3) 50%, transparent 70%);
            transform: translateX(-100%);
            transition: transform 0.6s;
        }

        .btn:hover::before {
            transform: translateX(100%);
        }

        .btn:hover {
            transform: translateY(-2px);
            box-shadow: var(--shadow);
        }

        .btn:active {
            transform: translateY(0);
        }

        .btn-primary {
            background: var(--gradient-primary);
            color: var(--white);
        }

        .btn-secondary {
            background: var(--white);
            color: var(--primary);
            border: 1px solid var(--primary-light);
        }

        .btn-secondary:hover {
            background: var(--primary-light);
            border-color: var(--primary);
        }

        .btn-ghost {
            background: transparent;
            color: var(--gray);
        }

        .btn-ghost:hover {
            background: var(--primary-light);
            color: var(--primary);
        }

        .btn-icon {
            width: 40px;
            height: 40px;
            padding: 0;
            display: flex;
            align-items: center;
            justify-content: center;
            background: transparent;
            border: none;
            border-radius: var(--border-radius);
            cursor: pointer;
            transition: var(--transition);
            color: var(--gray);
        }

        .btn-icon:hover {
            background: var(--primary-light);
            color: var(--primary);
            transform: scale(1.1);
        }

        /* Icons */
        .icon {
            width: 20px;
            height: 20px;
            stroke: currentColor;
            stroke-width: 2;
            fill: none;
        }

        .icon-sm {
            width: 16px;
            height: 16px;
        }

        .icon-lg {
            width: 24px;
            height: 24px;
        }

        /* Main Content */
        .main-content {
            flex: 1;
            display: flex;
            overflow: hidden;
        }

        /* Sidebar Moderne - Plus large */
        .sidebar {
            width: var(--sidebar-width);
            background: var(--white);
            border-right: 1px solid rgba(155, 135, 245, 0.1);
            display: flex;
            flex-direction: column;
            overflow: hidden;
            box-shadow: 4px 0 20px rgba(155, 135, 245, 0.05);
        }

        .sidebar-tabs {
            display: flex;
            background: var(--light-gray);
            padding: var(--space-2);
            gap: var(--space-1);
        }

        .sidebar-tab {
            flex: 1;
            padding: var(--space-3) var(--space-4);
            background: transparent;
            border: none;
            border-radius: var(--border-radius);
            cursor: pointer;
            font-size: var(--text-sm);
            font-weight: 600;
            font-family: var(--font-secondary);
            color: var(--gray);
            transition: var(--transition);
            position: relative;
        }

        .sidebar-tab:hover {
            background: rgba(155, 135, 245, 0.1);
            color: var(--primary);
        }

        .sidebar-tab.active {
            background: var(--white);
            color: var(--primary);
            box-shadow: var(--shadow);
        }

        .sidebar-tab.active::after {
            content: '';
            position: absolute;
            bottom: -2px;
            left: 20%;
            right: 20%;
            height: 3px;
            background: var(--gradient-primary);
            border-radius: 3px 3px 0 0;
        }

        /* Search Bar */
        .search-bar {
            padding: var(--space-4);
            background: var(--white);
            border-bottom: 1px solid rgba(155, 135, 245, 0.1);
        }

        .search-wrapper {
            position: relative;
        }

        .search-input {
            width: 100%;
            padding: var(--space-3) var(--space-4);
            padding-left: var(--space-12);
            border: 2px solid var(--primary-light);
            border-radius: var(--border-radius);
            font-size: var(--text-sm);
            font-family: var(--font-secondary);
            transition: var(--transition);
            background: var(--white);
        }

        .search-input:focus {
            outline: none;
            border-color: var(--primary);
            box-shadow: 0 0 0 4px rgba(155, 135, 245, 0.1);
        }

        .search-icon {
            position: absolute;
            left: var(--space-4);
            top: 50%;
            transform: translateY(-50%);
            color: var(--primary);
        }

        .sidebar-content {
            flex: 1;
            overflow-y: auto;
            padding: var(--space-4);
        }

        /* Preview Area */
        .preview-area {
            flex: 1;
            background: #f0f0f5;
            position: relative;
            overflow: hidden;
        }

        .preview-controls {
            position: absolute;
            top: var(--space-4);
            left: 50%;
            transform: translateX(-50%);
            display: flex;
            gap: var(--space-2);
            background: var(--white);
            padding: var(--space-2);
            border-radius: var(--border-radius);
            box-shadow: var(--shadow);
            z-index: 10;
        }

        .device-selector {
            display: flex;
            gap: 0;
            background: var(--primary-light);
            border-radius: var(--border-radius);
            padding: 4px;
        }

        .device-btn {
            padding: var(--space-2) var(--space-3);
            background: transparent;
            border: none;
            border-radius: calc(var(--border-radius) - 4px);
            cursor: pointer;
            font-size: var(--text-sm);
            font-weight: 500;
            color: var(--gray);
            transition: var(--transition);
        }

        .device-btn:hover {
            color: var(--primary);
        }

        .device-btn.active {
            background: var(--white);
            color: var(--primary);
            box-shadow: 0 2px 8px rgba(155, 135, 245, 0.2);
        }

        .preview-frame {
            position: absolute;
            top: 80px;
            left: 50%;
            transform: translateX(-50%);
            width: calc(100% - 40px);
            height: calc(100% - 100px);
            max-width: 1400px;
            background: var(--white);
            border-radius: var(--border-radius);
            box-shadow: 0 20px 60px rgba(155, 135, 245, 0.1);
            transition: var(--transition);
            overflow: hidden;
        }

        .preview-frame.mobile {
            width: 375px;
            max-width: 375px;
        }

        .preview-frame.tablet {
            width: 768px;
            max-width: 768px;
        }

        .preview-content {
            width: 100%;
            height: 100%;
            overflow: auto;
        }

        /* Properties Panel */
        .properties-panel {
            width: var(--properties-width);
            background: var(--white);
            border-left: 1px solid rgba(155, 135, 245, 0.1);
            display: flex;
            flex-direction: column;
            overflow: hidden;
            box-shadow: -4px 0 20px rgba(155, 135, 245, 0.05);
        }

        .properties-header {
            padding: var(--space-4);
            border-bottom: 1px solid rgba(155, 135, 245, 0.1);
            background: var(--light-gray);
        }

        .properties-header h2 {
            font-size: var(--text-lg);
            font-weight: 700;
            font-family: var(--font-primary);
            color: var(--dark);
        }

        .properties-content {
            flex: 1;
            overflow-y: auto;
        }

        .properties-section {
            padding: var(--space-4);
            border-bottom: 1px solid rgba(155, 135, 245, 0.05);
        }

        .properties-section-title {
            font-size: var(--text-sm);
            font-weight: 600;
            font-family: var(--font-primary);
            color: var(--primary);
            margin-bottom: var(--space-3);
            display: flex;
            align-items: center;
            gap: var(--space-2);
        }

        .property-group {
            margin-bottom: var(--space-4);
        }

        .property-label {
            font-size: var(--text-xs);
            font-weight: 600;
            font-family: var(--font-secondary);
            color: var(--gray);
            margin-bottom: var(--space-2);
            display: block;
            text-transform: uppercase;
            letter-spacing: 0.05em;
        }

        .property-input {
            width: 100%;
            padding: var(--space-3);
            border: 2px solid var(--primary-light);
            border-radius: var(--border-radius);
            font-size: var(--text-sm);
            font-family: var(--font-secondary);
            transition: var(--transition);
        }

        .property-input:focus {
            outline: none;
            border-color: var(--primary);
            box-shadow: 0 0 0 4px rgba(155, 135, 245, 0.1);
        }

        .property-select {
            width: 100%;
            padding: var(--space-3);
            border: 2px solid var(--primary-light);
            border-radius: var(--border-radius);
            font-size: var(--text-sm);
            font-family: var(--font-secondary);
            background: var(--white);
            cursor: pointer;
            transition: var(--transition);
        }

        /* Color Picker moderne */
        .color-picker-grid {
            display: grid;
            grid-template-columns: repeat(5, 1fr);
            gap: var(--space-2);
            margin-bottom: var(--space-3);
        }

        .color-swatch {
            width: 100%;
            aspect-ratio: 1;
            border-radius: var(--border-radius);
            cursor: pointer;
            transition: var(--transition);
            position: relative;
            overflow: hidden;
            border: 3px solid transparent;
        }

        .color-swatch:hover {
            transform: scale(1.1);
            box-shadow: 0 4px 12px rgba(0,0,0,0.2);
        }

        .color-swatch.active {
            border-color: var(--primary);
            box-shadow: 0 0 0 4px rgba(155, 135, 245, 0.2);
        }

        .color-swatch.active::after {
            content: '✓';
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            color: white;
            font-weight: bold;
            text-shadow: 0 1px 2px rgba(0,0,0,0.5);
        }

        /* Range Slider moderne */
        .range-slider {
            width: 100%;
            margin: var(--space-2) 0;
        }

        .range-input {
            width: 100%;
            height: 8px;
            border-radius: 20px;
            background: var(--primary-light);
            outline: none;
            -webkit-appearance: none;
        }

        .range-input::-webkit-slider-thumb {
            -webkit-appearance: none;
            width: 20px;
            height: 20px;
            border-radius: 50%;
            background: var(--gradient-primary);
            cursor: pointer;
            transition: var(--transition);
            box-shadow: 0 2px 8px rgba(155, 135, 245, 0.3);
        }

        .range-input::-webkit-slider-thumb:hover {
            transform: scale(1.2);
            box-shadow: 0 4px 12px rgba(155, 135, 245, 0.5);
        }

        .range-value {
            display: inline-block;
            min-width: 50px;
            text-align: right;
            font-size: var(--text-sm);
            font-weight: 600;
            color: var(--primary);
        }

        /* Templates et Sections Grid */
        .items-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(160px, 1fr));
            gap: var(--space-4);
        }

        .item-card {
            background: var(--white);
            border: 2px solid transparent;
            border-radius: var(--border-radius);
            overflow: hidden;
            cursor: pointer;
            transition: var(--transition);
            position: relative;
        }

        .item-card:hover {
            transform: translateY(-4px);
            box-shadow: var(--shadow);
            border-color: var(--primary-light);
        }

        .item-preview {
            aspect-ratio: 16/10;
            background: var(--gradient-primary);
            position: relative;
            overflow: hidden;
        }

        .item-preview img {
            width: 100%;
            height: 100%;
            object-fit: cover;
        }

        .item-badge {
            position: absolute;
            top: var(--space-2);
            right: var(--space-2);
            background: var(--gradient-primary);
            color: var(--white);
            padding: var(--space-1) var(--space-3);
            border-radius: 20px;
            font-size: var(--text-xs);
            font-weight: 600;
        }

        .item-info {
            padding: var(--space-3);
        }

        .item-name {
            font-size: var(--text-sm);
            font-weight: 700;
            font-family: var(--font-primary);
            color: var(--dark);
            margin-bottom: var(--space-1);
        }

        .item-description {
            font-size: var(--text-xs);
            color: var(--gray);
            line-height: 1.4;
        }

        /* Section draggable */
        .section-item {
            background: var(--white);
            border: 2px solid var(--primary-light);
            border-radius: var(--border-radius);
            padding: var(--space-3);
            margin-bottom: var(--space-2);
            cursor: move;
            transition: var(--transition);
            display: flex;
            align-items: center;
            gap: var(--space-3);
        }

        .section-item:hover {
            background: var(--primary-light);
            border-color: var(--primary);
            transform: translateX(4px);
        }

        .section-item.dragging {
            opacity: 0.5;
            transform: scale(0.95);
        }

        .section-handle {
            color: var(--primary);
            cursor: grab;
        }

        .section-handle:active {
            cursor: grabbing;
        }

        /* Category header */
        .category-header {
            font-size: var(--text-base);
            font-weight: 700;
            font-family: var(--font-primary);
            color: var(--primary);
            margin-bottom: var(--space-3);
            padding-bottom: var(--space-2);
            border-bottom: 2px solid var(--primary-light);
        }

        /* Client Manager */
        .client-list {
            display: flex;
            flex-direction: column;
            gap: var(--space-2);
        }

        .client-item {
            background: var(--white);
            border: 2px solid var(--primary-light);
            border-radius: var(--border-radius);
            padding: var(--space-4);
            cursor: pointer;
            transition: var(--transition);
        }

        .client-item:hover {
            background: var(--primary-light);
            border-color: var(--primary);
            transform: translateX(4px);
        }

        .client-name {
            font-weight: 700;
            font-family: var(--font-primary);
            color: var(--dark);
            margin-bottom: var(--space-1);
        }

        .client-info {
            font-size: var(--text-sm);
            color: var(--gray);
        }

        /* Édition inline moderne */
        .editable {
            position: relative;
            transition: var(--transition);
            cursor: pointer;
            outline: 2px solid transparent;
            outline-offset: 4px;
            border-radius: var(--border-radius);
        }

        .editable:hover {
            outline-color: var(--primary-light);
            background-color: rgba(155, 135, 245, 0.05);
        }

        .editable.editing {
            outline-color: var(--primary);
            background-color: rgba(155, 135, 245, 0.1);
        }

        .editable-link {
            position: relative;
            text-decoration: underline;
            text-decoration-color: var(--primary);
            text-underline-offset: 3px;
        }

        .editable-link:hover {
            text-decoration-color: var(--primary-dark);
        }

        /* Image placeholder */
        .image-placeholder {
            width: 100%;
            height: 100%;
            background: var(--gradient-primary);
            border: 3px dashed var(--primary);
            border-radius: var(--border-radius);
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            transition: var(--transition);
            position: relative;
            overflow: hidden;
        }

        .image-placeholder:hover {
            background: var(--primary-light);
            border-color: var(--primary-dark);
            transform: scale(0.98);
        }

        .image-placeholder-icon {
            width: 48px;
            height: 48px;
            color: var(--white);
            margin-bottom: var(--space-2);
        }

        .image-placeholder-text {
            font-size: var(--text-sm);
            color: var(--white);
            font-weight: 600;
        }

        .image-preview {
            width: 100%;
            height: 100%;
            object-fit: cover;
            cursor: pointer;
            border-radius: var(--border-radius);
        }

        /* Floating Toolbar moderne */
        .floating-toolbar {
            position: fixed;
            background: var(--white);
            border: 2px solid var(--primary-light);
            border-radius: var(--border-radius);
            padding: var(--space-2);
            display: none;
            box-shadow: var(--shadow);
            z-index: 1000;
            gap: var(--space-1);
        }

        .floating-toolbar.active {
            display: flex;
        }

        .toolbar-btn {
            width: 36px;
            height: 36px;
            display: flex;
            align-items: center;
            justify-content: center;
            background: var(--white);
            border: none;
            border-radius: var(--border-radius);
            cursor: pointer;
            transition: var(--transition);
            color: var(--gray);
        }

        .toolbar-btn:hover {
            background: var(--primary-light);
            color: var(--primary);
        }

        .toolbar-btn.active {
            background: var(--gradient-primary);
            color: var(--white);
        }

        .toolbar-divider {
            width: 1px;
            height: 24px;
            background: var(--primary-light);
            margin: 0 var(--space-1);
        }

        /* Modals modernes */
        .modal-backdrop {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(26, 31, 44, 0.8);
            backdrop-filter: blur(8px);
            display: none;
            align-items: center;
            justify-content: center;
            z-index: 2000;
            padding: var(--space-4);
        }

        .modal-backdrop.active {
            display: flex;
        }

        .modal {
            background: var(--white);
            border-radius: var(--border-radius);
            width: 100%;
            max-width: 600px;
            max-height: 90vh;
            overflow: hidden;
            display: flex;
            flex-direction: column;
            box-shadow: 0 20px 60px rgba(0, 0, 0, 0.3);
        }

        .modal-header {
            padding: var(--space-6);
            border-bottom: 1px solid var(--primary-light);
            background: var(--light-gray);
        }

        .modal-title {
            font-size: var(--text-xl);
            font-weight: 700;
            font-family: var(--font-primary);
            color: var(--dark);
        }

        .modal-body {
            padding: var(--space-6);
            overflow-y: auto;
            flex: 1;
        }

        .modal-footer {
            padding: var(--space-4) var(--space-6);
            display: flex;
            gap: var(--space-3);
            justify-content: flex-end;
            border-top: 1px solid var(--primary-light);
            background: var(--light-gray);
        }

        /* Gallery avec animations */
        .gallery-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(200px, 1fr));
            gap: var(--space-3);
            padding: var(--space-4);
        }

        .gallery-item {
            position: relative;
            aspect-ratio: 1;
            border-radius: var(--border-radius);
            overflow: hidden;
            cursor: pointer;
            transition: var(--transition);
        }

        .gallery-item:hover {
            transform: scale(1.05) rotate(2deg);
            box-shadow: var(--shadow);
        }

        .gallery-item img {
            width: 100%;
            height: 100%;
            object-fit: cover;
        }

        .gallery-overlay {
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: linear-gradient(to bottom, transparent 0%, rgba(26, 31, 44, 0.8) 100%);
            opacity: 0;
            transition: opacity var(--transition);
            display: flex;
            align-items: flex-end;
            padding: var(--space-3);
        }

        .gallery-item:hover .gallery-overlay {
            opacity: 1;
        }

        .gallery-caption {
            color: var(--white);
            font-size: var(--text-sm);
            font-weight: 600;
            font-family: var(--font-primary);
        }

        /* Toast notifications modernes */
        .toast-container {
            position: fixed;
            bottom: var(--space-4);
            right: var(--space-4);
            z-index: 3000;
            display: flex;
            flex-direction: column;
            gap: var(--space-3);
        }

        .toast {
            background: var(--white);
            border-radius: var(--border-radius);
            padding: var(--space-4);
            box-shadow: var(--shadow);
            display: flex;
            align-items: center;
            gap: var(--space-3);
            min-width: 320px;
            animation: slideIn var(--transition) ease-out;
            border-left: 4px solid;
        }

        @keyframes slideIn {
            from {
                transform: translateX(100%);
                opacity: 0;
            }
            to {
                transform: translateX(0);
                opacity: 1;
            }
        }

        .toast-icon {
            width: 24px;
            height: 24px;
            flex-shrink: 0;
        }

        .toast.success {
            border-left-color: #10b981;
        }

        .toast.success .toast-icon {
            color: #10b981;
        }

        .toast.error {
            border-left-color: #ef4444;
        }

        .toast.error .toast-icon {
            color: #ef4444;
        }

        .toast.info {
            border-left-color: var(--primary);
        }

        .toast.info .toast-icon {
            color: var(--primary);
        }

        .toast-message {
            flex: 1;
            font-size: var(--text-sm);
            color: var(--dark);
            font-weight: 500;
        }

        /* Loading states */
        .loading {
            display: flex;
            align-items: center;
            justify-content: center;
            min-height: 200px;
        }

        .spinner {
            width: 48px;
            height: 48px;
            border: 4px solid var(--primary-light);
            border-top-color: var(--primary);
            border-radius: 50%;
            animation: spin 0.8s linear infinite;
        }

        @keyframes spin {
            to { transform: rotate(360deg); }
        }

        /* Responsive Margin Controls */
        .margin-controls {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: var(--space-2);
        }

        .margin-input-group {
            display: flex;
            align-items: center;
            gap: var(--space-2);
        }

        .margin-label {
            font-size: var(--text-xs);
            color: var(--gray);
            min-width: 50px;
        }

        .margin-input {
            width: 70px;
            padding: var(--space-2);
            border: 2px solid var(--primary-light);
            border-radius: var(--border-radius);
            font-size: var(--text-xs);
            text-align: center;
        }

        /* Section Manager */
        .section-container {
            position: relative;
            padding: var(--space-4);
            margin: var(--space-2) 0;
            border: 2px solid transparent;
            border-radius: var(--border-radius);
            transition: var(--transition);
        }

        .section-container:hover {
            border-color: var(--primary-light);
            background: rgba(155, 135, 245, 0.05);
        }

        .section-container.selected {
            border-color: var(--primary);
            background: rgba(155, 135, 245, 0.1);
        }

        .section-controls {
            position: absolute;
            top: var(--space-2);
            right: var(--space-2);
            display: flex;
            gap: var(--space-1);
            opacity: 0;
            transition: opacity var(--transition);
        }

        .section-container:hover .section-controls {
            opacity: 1;
        }

        .section-control-btn {
            width: 32px;
            height: 32px;
            background: var(--white);
            border: 2px solid var(--primary-light);
            border-radius: var(--border-radius);
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            transition: var(--transition);
        }

        .section-control-btn:hover {
            background: var(--primary-light);
            border-color: var(--primary);
        }

        /* Drag ghost */
        .sortable-ghost {
            opacity: 0.4;
            background: var(--primary-light);
        }

        .sortable-drag {
            opacity: 1 !important;
            transform: scale(1.02);
            box-shadow: var(--shadow);
        }

        /* Search Results */
        .search-results {
            margin-top: var(--space-4);
        }

        .no-results {
            text-align: center;
            padding: var(--space-8) var(--space-4);
            color: var(--gray);
        }

        .highlight {
            background: var(--accent);
            color: var(--dark);
            padding: 0 4px;
            border-radius: 4px;
            font-weight: 600;
        }

        /* Palette de couleurs */
        .palette-grid {
            display: grid;
            gap: var(--space-3);
        }

        .palette-item {
            background: var(--white);
            border: 2px solid var(--primary-light);
            border-radius: var(--border-radius);
            padding: var(--space-3);
            cursor: pointer;
            transition: var(--transition);
        }

        .palette-item:hover {
            border-color: var(--primary);
            box-shadow: var(--shadow);
            transform: translateY(-2px);
        }

        .palette-colors {
            display: flex;
            gap: var(--space-1);
            margin-bottom: var(--space-2);
        }

        .palette-color {
            width: 40px;
            height: 40px;
            border-radius: var(--border-radius);
            position: relative;
            overflow: hidden;
        }

        .palette-color:first-child {
            flex: 2;
        }

        .palette-name {
            font-size: var(--text-sm);
            font-weight: 700;
            font-family: var(--font-primary);
            color: var(--dark);
        }

        /* Hide scrollbar but keep functionality */
        .sidebar-content::-webkit-scrollbar,
        .properties-content::-webkit-scrollbar {
            width: 8px;
        }

        .sidebar-content::-webkit-scrollbar-track,
        .properties-content::-webkit-scrollbar-track {
            background: var(--light-gray);
            border-radius: 10px;
        }

        .sidebar-content::-webkit-scrollbar-thumb,
        .properties-content::-webkit-scrollbar-thumb {
            background: var(--primary-light);
            border-radius: 10px;
        }

        .sidebar-content::-webkit-scrollbar-thumb:hover,
        .properties-content::-webkit-scrollbar-thumb:hover {
            background: var(--primary);
        }

        /* Template styles reset */
        #preview-content * {
            font-family: inherit;
        }

        #preview-content h1,
        #preview-content h2,
        #preview-content h3,
        #preview-content h4,
        #preview-content h5,
        #preview-content h6 {
            font-family: var(--font-primary);
        }

        #preview-content p,
        #preview-content span,
        #preview-content div,
        #preview-content li,
        #preview-content a {
            font-family: var(--font-secondary);
        }
    </style>
</head>
<body>
    <div class="app-container">
        <!-- Toolbar -->
        <div class="toolbar">
            <div class="toolbar-logo">
                <svg class="icon" viewBox="0 0 24 24" fill="currentColor">
                    <path d="M3 13h8V3H3v10zm0 8h8v-6H3v6zm10 0h8V11h-8v10zm0-18v6h8V3h-8z"/>
                </svg>
                ComfyCMS
            </div>

            <div id="project-name-display" class="project-name-btn" onclick="comfyCMS.renameProject()" title="Renommer le projet">
                Nouveau Projet
            </div>
            
            <div class="toolbar-divider"></div>
            
            <div class="toolbar-section">
                <button class="btn-icon" title="Nouveau projet" onclick="comfyCMS.newProject()">
                    <svg class="icon" viewBox="0 0 24 24">
                        <path d="M12 5v14m-7-7h14"/>
                    </svg>
                </button>
                <button class="btn-icon" title="Ouvrir" onclick="comfyCMS.openProject()">
                    <svg class="icon" viewBox="0 0 24 24">
                        <path d="M3 7v10a2 2 0 002 2h14a2 2 0 002-2V9a2 2 0 00-2-2h-6l-2-2H5a2 2 0 00-2 2z"/>
                    </svg>
                </button>
                <button class="btn-icon" title="Sauvegarder" onclick="comfyCMS.saveProject()">
                    <svg class="icon" viewBox="0 0 24 24">
                        <path d="M19 21H5a2 2 0 01-2-2V5a2 2 0 012-2h11l5 5v11a2 2 0 01-2 2z"/>
                        <polyline points="17 21 17 13 7 13 7 21"/>
                        <polyline points="7 3 7 8 15 8"/>
                    </svg>
                </button>
            </div>
            
            <div class="toolbar-divider"></div>
            
            <div class="toolbar-section">
                <button class="btn-icon" title="Annuler" onclick="comfyCMS.undo()">
                    <svg class="icon" viewBox="0 0 24 24">
                        <path d="M3 7v6h6"/><path d="M21 17a9 9 0 00-9-9 9 9 0 00-6 2.3L3 13"/>
                    </svg>
                </button>
                <button class="btn-icon" title="Refaire" onclick="comfyCMS.redo()">
                    <svg class="icon" viewBox="0 0 24 24">
                        <path d="M21 7v6h-6"/><path d="M3 17a9 9 0 019-9 9 9 0 016 2.3l3 2.7"/>
                    </svg>
                </button>
            </div>
            
            <div class="toolbar-section" style="margin-left: auto;">
                <button class="btn btn-ghost" onclick="comfyCMS.showSeoSettings()" title="Paramètres SEO">
                    <svg class="icon icon-sm" viewBox="0 0 24 24" fill="none" stroke="currentColor">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M17.657 16.657L13.414 20.9a1.998 1.998 0 01-2.827 0l-4.244-4.243a8 8 0 1111.314 0z" />
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 11a3 3 0 11-6 0 3 3 0 016 0z" />
                    </svg>
                    SEO
                </button>
                <button class="btn btn-secondary" onclick="comfyCMS.preview()">
                    <svg class="icon icon-sm" viewBox="0 0 24 24">
                        <path d="M1 12s4-8 11-8 11 8 11 8-4 8-11 8-11-8-11-8z"/>
                        <circle cx="12" cy="12" r="3"/>
                    </svg>
                    Prévisualiser
                </button>
                <button class="btn btn-primary" onclick="comfyCMS.exportProject()">
                    <svg class="icon icon-sm" viewBox="0 0 24 24">
                        <path d="M21 15v4a2 2 0 01-2 2H5a2 2 0 01-2-2v-4"/>
                        <polyline points="7 10 12 15 17 10"/>
                        <line x1="12" y1="15" x2="12" y2="3"/>
                    </svg>
                    Exporter
                </button>
            </div>
        </div>

        <!-- Main Content -->
        <div class="main-content">
            <!-- Sidebar -->
            <div class="sidebar">
                <div class="sidebar-tabs">
                    <button class="sidebar-tab active" onclick="comfyCMS.switchTab('templates')">Templates</button>
                    <button class="sidebar-tab" onclick="comfyCMS.switchTab('sections')">Sections</button>
                    <button class="sidebar-tab" onclick="comfyCMS.switchTab('clients')">Clients</button>
                    <button class="sidebar-tab" onclick="comfyCMS.switchTab('assets')">Assets</button>
                </div>
                
                <div class="search-bar">
                    <div class="search-wrapper">
                        <svg class="icon icon-sm search-icon" viewBox="0 0 24 24">
                            <circle cx="11" cy="11" r="8"/>
                            <path d="m21 21-4.35-4.35"/>
                        </svg>
                        <input type="text" class="search-input" id="search-input" placeholder="Rechercher..." onkeyup="comfyCMS.search(this.value)">
                    </div>
                </div>
                
                <div class="sidebar-content" id="sidebar-content">
                    <!-- Le contenu sera injecté dynamiquement -->
                </div>
            </div>

            <!-- Preview Area -->
            <div class="preview-area">
                <div class="preview-controls">
                    <div class="device-selector">
                        <button class="device-btn" onclick="comfyCMS.setDevice('mobile')">
                            <svg class="icon icon-sm" viewBox="0 0 24 24">
                                <rect x="5" y="2" width="14" height="20" rx="2" ry="2"/>
                                <line x1="12" y1="18" x2="12" y2="18"/>
                            </svg>
                        </button>
                        <button class="device-btn" onclick="comfyCMS.setDevice('tablet')">
                            <svg class="icon icon-sm" viewBox="0 0 24 24">
                                <rect x="4" y="2" width="16" height="20" rx="2" ry="2"/>
                                <line x1="12" y1="18" x2="12" y2="18"/>
                            </svg>
                        </button>
                        <button class="device-btn active" onclick="comfyCMS.setDevice('desktop')">
                            <svg class="icon icon-sm" viewBox="0 0 24 24">
                                <rect x="2" y="3" width="20" height="14" rx="2" ry="2"/>
                                <line x1="8" y1="21" x2="16" y2="21"/>
                                <line x1="12" y1="17" x2="12" y2="21"/>
                            </svg>
                        </button>
                    </div>
                    
                    <button class="btn-icon" title="Zoom -" onclick="comfyCMS.zoom('out')">
                        <svg class="icon icon-sm" viewBox="0 0 24 24">
                            <circle cx="11" cy="11" r="8"/>
                            <path d="m21 21-4.35-4.35"/>
                            <line x1="8" y1="11" x2="14" y2="11"/>
                        </svg>
                    </button>
                    <span style="font-size: var(--text-sm); color: var(--primary); font-weight: 600;" id="zoom-level">100%</span>
                    <button class="btn-icon" title="Zoom +" onclick="comfyCMS.zoom('in')">
                        <svg class="icon icon-sm" viewBox="0 0 24 24">
                            <circle cx="11" cy="11" r="8"/>
                            <path d="m21 21-4.35-4.35"/>
                            <line x1="11" y1="8" x2="11" y2="14"/>
                            <line x1="8" y1="11" x2="14" y2="11"/>
                        </svg>
                    </button>
                </div>
                
                <div class="preview-frame" id="preview-frame">
                    <div class="preview-content" id="preview-content">
                        <!-- Le contenu du site sera affiché ici -->
                    </div>
                </div>
            </div>

            <!-- Properties Panel -->
            <div class="properties-panel">
                <div class="properties-header">
                    <h2>Propriétés</h2>
                </div>
                
                <div class="properties-content" id="properties-content">
                    <!-- Les propriétés seront affichées ici -->
                </div>
            </div>
        </div>
    </div>

    <!-- Floating Toolbar -->
    <div class="floating-toolbar" id="floating-toolbar">
        <button class="toolbar-btn" onclick="comfyCMS.textCommand('bold')" title="Gras">
            <svg class="icon icon-sm" viewBox="0 0 24 24">
                <path d="M6 4h8a4 4 0 014 4 4 4 0 01-4 4H6z"/>
                <path d="M6 12h9a4 4 0 014 4 4 4 0 01-4 4H6z"/>
            </svg>
        </button>
        <button class="toolbar-btn" onclick="comfyCMS.textCommand('italic')" title="Italique">
            <svg class="icon icon-sm" viewBox="0 0 24 24">
                <line x1="19" y1="4" x2="10" y2="4"/>
                <line x1="14" y1="20" x2="5" y2="20"/>
                <line x1="15" y1="4" x2="9" y2="20"/>
            </svg>
        </button>
        <button class="toolbar-btn" onclick="comfyCMS.textCommand('underline')" title="Souligné">
            <svg class="icon icon-sm" viewBox="0 0 24 24">
                <path d="M6 3v7a6 6 0 006 6 6 6 0 006-6V3"/>
                <line x1="4" y1="21" x2="20" y2="21"/>
            </svg>
        </button>
        <div class="toolbar-divider"></div>
        <button class="toolbar-btn" onclick="comfyCMS.insertLink()" title="Lien">
            <svg class="icon icon-sm" viewBox="0 0 24 24">
                <path d="M10 13a5 5 0 007.54.54l3-3a5 5 0 00-7.07-7.07l-1.72 1.71"/>
                <path d="M14 11a5 5 0 00-7.54-.54l-3 3a5 5 0 007.07 7.07l1.71-1.71"/>
            </svg>
        </button>
        <button class="toolbar-btn" onclick="comfyCMS.changeTextColor()" title="Couleur">
            <svg class="icon icon-sm" viewBox="0 0 24 24">
                <path d="M12 2l3.09 6.31L22 9.24l-5 4.87L18.18 21 12 17.77 5.82 21 7 14.11l-5-4.87 6.91-.93L12 2z" fill="currentColor"/>
            </svg>
        </button>
    </div>

    <!-- Modal Container -->
    <div class="modal-backdrop" id="modal-backdrop" onclick="comfyCMS.closeModal(event)">
        <div class="modal" id="modal" onclick="event.stopPropagation()">
            <div class="modal-header">
                <h3 class="modal-title" id="modal-title">Titre</h3>
            </div>
            <div class="modal-body" id="modal-body">
                <!-- Contenu du modal -->
            </div>
            <div class="modal-footer" id="modal-footer">
                <button class="btn btn-secondary" onclick="comfyCMS.closeModal()">Annuler</button>
                <button class="btn btn-primary" id="modal-confirm">Confirmer</button>
            </div>
        </div>
    </div>

    <!-- Toast Container -->
    <div class="toast-container" id="toast-container"></div>

    <!-- Hidden file inputs -->
    <input type="file" id="image-upload" style="display: none" accept="image/*" onchange="comfyCMS.handleImageUpload(this)">

    <!-- JavaScript -->
    <script>
        // ComfyCMS Application Core - Version Complète et Améliorée
        class ComfyCMS {
            constructor() {
                // État de l'application
                this.currentProject = null;
                this.currentTemplate = null;
                this.selectedElement = null;
                this.currentDevice = 'desktop';
                this.zoomLevel = 100;
                this.history = [];
                this.historyIndex = -1;
                this.currentTab = 'templates';
                
                // Gestionnaires
                this.clientManager = new ClientManager();
                this.sectionManager = new SectionManager();
                this.colorManager = new ColorManager();
                this.marginManager = new MarginManager();
                
                // Données
                this.templates = [];
                this.sections = [];
                this.allSections = []; // Toutes les sections disponibles
                
                // Couleurs prédéfinies (palette ComfyClick)
                this.colorPalettes = [
                    {
                        name: "ComfyClick Original",
                        primary: "#9b87f5",
                        secondary: "#ff8e6e",
                        accent: "#ffc85c",
                        neutral: "#8e9196",
                        background: "#ffffff"
                    },
                    {
                        name: "Océan Profond",
                        primary: "#0EA5E9",
                        secondary: "#06B6D4",
                        accent: "#14B8A6",
                        neutral: "#64748B",
                        background: "#F0F9FF"
                    },
                    {
                        name: "Forêt Mystique",
                        primary: "#10B981",
                        secondary: "#059669",
                        accent: "#84CC16",
                        neutral: "#6B7280",
                        background: "#F0FDF4"
                    },
                    {
                        name: "Coucher de Soleil",
                        primary: "#F59E0B",
                        secondary: "#EF4444",
                        accent: "#F97316",
                        neutral: "#78716C",
                        background: "#FFFBEB"
                    },
                    {
                        name: "Nuit Étoilée",
                        primary: "#6366F1",
                        secondary: "#8B5CF6",
                        accent: "#A78BFA",
                        neutral: "#475569",
                        background: "#1E293B"
                    },
                    {
                        name: "Rose Garden",
                        primary: "#EC4899",
                        secondary: "#F472B6",
                        accent: "#FB7185",
                        neutral: "#9CA3AF",
                        background: "#FDF2F8"
                    },
                    {
                        name: "Tech Moderne",
                        primary: "#2563EB",
                        secondary: "#7C3AED",
                        accent: "#06B6D4",
                        neutral: "#6B7280",
                        background: "#F8FAFC"
                    },
                    {
                        name: "Terre Naturelle",
                        primary: "#92400E",
                        secondary: "#B45309",
                        accent: "#D97706",
                        neutral: "#78716C",
                        background: "#FEF3C7"
                    },
                    {
                        name: "Monochrome Élégant",
                        primary: "#18181B",
                        secondary: "#3F3F46",
                        accent: "#71717A",
                        neutral: "#A1A1AA",
                        background: "#FAFAFA"
                    },
                    {
                        name: "Candy Pop",
                        primary: "#EC4899",
                        secondary: "#8B5CF6",
                        accent: "#3B82F6",
                        neutral: "#6B7280",
                        background: "#FEF3F3"
                    }
                ];
                
                this.init();
            }
            
            async init() {
                // Charger les données
                await this.loadTemplates();
                await this.loadSections();
                
                // Initialiser les gestionnaires
                this.setupEventListeners();
                this.setupDragAndDrop();
                
                // Créer un nouveau projet
                this.createNewProject();
                
                // Message de bienvenue
                this.showToast('Bienvenue dans ComfyCMS! 🚀', 'success');
            }
            
            setupEventListeners() {
                // Écouter les clics sur les éléments éditables
                document.addEventListener('click', (e) => {
                    // Gérer les éléments éditables
                    if (e.target.closest('.editable')) {
                        e.preventDefault();
                        this.selectElement(e.target.closest('.editable'));
                    }
                    
                    // Gérer les liens éditables
                    if (e.target.closest('.editable-link')) {
                        e.preventDefault();
                        this.editLink(e.target.closest('.editable-link'));
                    }
                    
                    // Gérer les images cliquables
                    if (e.target.closest('.image-placeholder, .image-preview')) {
                        e.preventDefault();
                        this.uploadImage(e.target.closest('.image-placeholder, .image-preview'));
                    }
                });
                
                // Double-clic pour édition rapide
                document.addEventListener('dblclick', (e) => {
                    if (e.target.closest('.editable')) {
                        e.preventDefault();
                        this.enableInlineEditing(e.target.closest('.editable'));
                    }
                });
                
                // Raccourcis clavier
                document.addEventListener('keydown', (e) => {
                    if (e.ctrlKey || e.metaKey) {
                        switch(e.key.toLowerCase()) {
                            case 'z':
                                e.preventDefault();
                                this.undo();
                                break;
                            case 'y':
                                e.preventDefault();
                                this.redo();
                                break;
                            case 's':
                                e.preventDefault();
                                this.saveProject();
                                break;
                            case 'e':
                                e.preventDefault();
                                this.exportProject();
                                break;
                        }
                    }
                    
                    // Supprimer une section avec Delete
                    if (e.key === 'Delete' && this.selectedElement?.closest('.section-container')) {
                        this.deleteSection(this.selectedElement.closest('.section-container'));
                    }
                });
                
                // Fermer la toolbar flottante au clic extérieur
                document.addEventListener('mousedown', (e) => {
                    if (!e.target.closest('.floating-toolbar') && !e.target.closest('.editable')) {
                        document.getElementById('floating-toolbar').classList.remove('active');
                    }
                });
            }
            
            setupDragAndDrop() {
                // Initialiser Sortable.js pour le drag & drop des sections
                const previewContent = document.getElementById('preview-content');
                if (previewContent) {
                    this.sortable = Sortable.create(previewContent, {
                        group: 'sections',
                        animation: 150,
                        handle: '.section-handle',
                        ghostClass: 'sortable-ghost',
                        dragClass: 'sortable-drag',
                        onEnd: (evt) => {
                            this.saveHistory();
                            this.showToast('Section déplacée', 'info');
                        }
                    });
                }
            }
            
            // Chargement des données
            async loadTemplates() {
                // Templates de démonstration
                this.templates = [
                    {
                        id: 'restaurant-moderne',
                        name: 'Restaurant Moderne',
                        category: 'Restaurant',
                        description: 'Template élégant pour restaurants avec menu et réservation',
                        preview: '/assets/templates/restaurant.jpg',
                        sections: ['header-restaurant', 'hero-restaurant', 'menu-restaurant', 'gallery-restaurant', 'contact-restaurant'],
                        html: `
                            <header class="header-restaurant section-container" data-section-id="header-restaurant">
                                <nav class="nav">
                                    <h1 class="logo editable">Le Gourmet</h1>
                                    <ul class="menu">
                                        <li><a href="#home" class="editable-link">Accueil</a></li>
                                        <li><a href="#menu" class="editable-link">Menu</a></li>
                                        <li><a href="#about" class="editable-link">À propos</a></li>
                                        <li><a href="#contact" class="editable-link">Contact</a></li>
                                    </ul>
                                </nav>
                            </header>
                            <section class="hero-restaurant section-container" data-section-id="hero-restaurant">
                                <div class="hero-content">
                                    <h2 class="hero-title editable">Bienvenue au Gourmet</h2>
                                    <p class="hero-subtitle editable">Une expérience culinaire unique</p>
                                    <a href="#reservation" class="cta-button editable editable-link">Réserver une table</a>
                                </div>
                                <div class="hero-image image-placeholder" onclick="comfyCMS.uploadImage(this)">
                                    <svg class="image-placeholder-icon" viewBox="0 0 24 24">
                                        <rect x="3" y="3" width="18" height="18" rx="2" ry="2"/>
                                        <circle cx="8.5" cy="8.5" r="1.5"/>
                                        <polyline points="21 15 16 10 5 21"/>
                                    </svg>
                                    <p class="image-placeholder-text">Cliquez pour ajouter une image</p>
                                </div>
                            </section>
                        `,
                        css: `
                            .header-restaurant { 
                                background: var(--color-background); 
                                padding: 1rem 2rem;
                                box-shadow: 0 2px 4px rgba(0,0,0,0.1);
                            }
                            .nav { 
                                display: flex; 
                                justify-content: space-between; 
                                align-items: center;
                                max-width: 1200px;
                                margin: 0 auto;
                            }
                            .logo { 
                                font-size: 1.5rem; 
                                margin: 0;
                                color: var(--color-primary);
                                font-weight: 700;
                            }
                            .menu { 
                                display: flex; 
                                list-style: none; 
                                gap: 2rem; 
                                margin: 0;
                                padding: 0;
                            }
                            .menu a { 
                                color: var(--color-neutral); 
                                text-decoration: none;
                                transition: color 0.3s;
                                font-weight: 500;
                            }
                            .menu a:hover {
                                color: var(--color-primary);
                            }
                            .hero-restaurant { 
                                display: grid;
                                grid-template-columns: 1fr 1fr;
                                align-items: center;
                                gap: 3rem;
                                padding: 4rem 2rem; 
                                background: linear-gradient(135deg, var(--color-background) 0%, var(--color-background-alt) 100%);
                                max-width: 1200px;
                                margin: 0 auto;
                            }
                            .hero-content {
                                text-align: left;
                            }
                            .hero-title { 
                                font-size: 3rem; 
                                margin-bottom: 1rem;
                                color: var(--color-primary);
                                line-height: 1.2;
                            }
                            .hero-subtitle { 
                                font-size: 1.25rem; 
                                color: var(--color-neutral); 
                                margin-bottom: 2rem;
                                line-height: 1.6;
                            }
                            .cta-button { 
                                display: inline-block;
                                background: var(--color-primary); 
                                color: white; 
                                padding: 1rem 2rem; 
                                font-size: 1.1rem; 
                                border-radius: 0.5rem; 
                                text-decoration: none;
                                transition: all 0.3s;
                                font-weight: 600;
                            }
                            .cta-button:hover {
                                background: var(--color-primary-dark);
                                transform: translateY(-2px);
                                box-shadow: 0 4px 12px rgba(155, 135, 245, 0.3);
                            }
                            .hero-image {
                                width: 100%;
                                height: 400px;
                                border-radius: 1rem;
                                overflow: hidden;
                            }
                            @media (max-width: 768px) {
                                .hero-restaurant {
                                    grid-template-columns: 1fr;
                                    text-align: center;
                                }
                                .hero-content {
                                    text-align: center;
                                }
                                .hero-title {
                                    font-size: 2rem;
                                }
                                .menu {
                                    flex-direction: column;
                                    gap: 1rem;
                                }
                            }
                        `
                    },
                    {
                        id: 'portfolio-moderne',
                        name: 'Portfolio Moderne',
                        category: 'Portfolio',
                        description: 'Portfolio créatif avec animations et galerie',
                        preview: '/assets/templates/portfolio.jpg',
                        sections: ['header-portfolio', 'hero-portfolio', 'projects-portfolio', 'about-portfolio'],
                        html: `
                            <header class="header-portfolio section-container" data-section-id="header-portfolio">
                                <div class="header-content">
                                    <h1 class="name editable">John Doe</h1>
                                    <p class="tagline editable">Designer Créatif</p>
                                </div>
                            </header>
                            <section class="hero-portfolio section-container" data-section-id="hero-portfolio">
                                <div class="hero-text">
                                    <h2 class="hero-title editable">Créons ensemble</h2>
                                    <p class="hero-desc editable">Je transforme vos idées en expériences visuelles uniques</p>
                                </div>
                            </section>
                        `,
                        css: `
                            .header-portfolio {
                                text-align: center;
                                padding: 3rem;
                                background: linear-gradient(135deg, var(--color-primary) 0%, var(--color-secondary) 100%);
                                color: white;
                            }
                            .name {
                                font-size: 2.5rem;
                                margin-bottom: 0.5rem;
                                font-weight: 700;
                            }
                            .tagline {
                                font-size: 1.2rem;
                                opacity: 0.9;
                            }
                            .hero-portfolio {
                                padding: 5rem 2rem;
                                text-align: center;
                                background: var(--color-background);
                            }
                            .hero-title {
                                font-size: 3.5rem;
                                margin-bottom: 1rem;
                                color: var(--color-primary);
                            }
                            .hero-desc {
                                font-size: 1.3rem;
                                color: var(--color-neutral);
                                max-width: 600px;
                                margin: 0 auto;
                            }
                        `
                    },
                    {
                        id: 'business-pro',
                        name: 'Business Pro',
                        category: 'Business',
                        description: 'Template professionnel pour entreprises et startups',
                        preview: '/assets/templates/business.jpg',
                        sections: ['header-business', 'hero-business', 'services-business', 'team-business'],
                        html: `
                            <header class="header-business section-container" data-section-id="header-business">
                                <nav class="nav-business">
                                    <div class="logo-container">
                                        <h1 class="logo editable">BusinessPro</h1>
                                    </div>
                                    <ul class="nav-menu">
                                        <li><a href="#services" class="editable-link">Services</a></li>
                                        <li><a href="#about" class="editable-link">À propos</a></li>
                                        <li><a href="#team" class="editable-link">Équipe</a></li>
                                        <li><a href="#contact" class="cta-nav editable-link">Contact</a></li>
                                    </ul>
                                </nav>
                            </header>
                            <section class="hero-business section-container" data-section-id="hero-business">
                                <div class="hero-grid">
                                    <div class="hero-content">
                                        <h2 class="hero-title editable">Votre partenaire digital de confiance</h2>
                                        <p class="hero-text editable">Nous transformons vos idées en solutions digitales innovantes pour propulser votre entreprise vers le succès.</p>
                                        <div class="hero-buttons">
                                            <a href="#demo" class="btn-primary editable editable-link">Demander une démo</a>
                                            <a href="#services" class="btn-secondary editable editable-link">Nos services</a>
                                        </div>
                                    </div>
                                    <div class="hero-visual image-placeholder" onclick="comfyCMS.uploadImage(this)">
                                        <svg class="image-placeholder-icon" viewBox="0 0 24 24">
                                            <rect x="3" y="3" width="18" height="18" rx="2" ry="2"/>
                                            <circle cx="8.5" cy="8.5" r="1.5"/>
                                            <polyline points="21 15 16 10 5 21"/>
                                        </svg>
                                        <p class="image-placeholder-text">Ajouter une image</p>
                                    </div>
                                </div>
                            </section>
                        `,
                        css: `
                            .header-business {
                                background: var(--color-background);
                                padding: 1rem 2rem;
                                position: sticky;
                                top: 0;
                                z-index: 100;
                                box-shadow: 0 2px 10px rgba(0,0,0,0.1);
                            }
                            .nav-business {
                                display: flex;
                                justify-content: space-between;
                                align-items: center;
                                max-width: 1200px;
                                margin: 0 auto;
                            }
                            .logo-container .logo {
                                font-size: 1.8rem;
                                color: var(--color-primary);
                                margin: 0;
                            }
                            .nav-menu {
                                display: flex;
                                list-style: none;
                                gap: 2rem;
                                align-items: center;
                                margin: 0;
                                padding: 0;
                            }
                            .nav-menu a {
                                color: var(--color-neutral);
                                text-decoration: none;
                                font-weight: 500;
                                transition: color 0.3s;
                            }
                            .nav-menu a:hover {
                                color: var(--color-primary);
                            }
                            .cta-nav {
                                background: var(--color-primary);
                                color: white !important;
                                padding: 0.75rem 1.5rem;
                                border-radius: 0.5rem;
                            }
                            .cta-nav:hover {
                                background: var(--color-primary-dark);
                            }
                            .hero-business {
                                padding: 5rem 2rem;
                                background: linear-gradient(135deg, var(--color-background) 0%, rgba(155, 135, 245, 0.05) 100%);
                            }
                            .hero-grid {
                                display: grid;
                                grid-template-columns: 1fr 1fr;
                                gap: 4rem;
                                align-items: center;
                                max-width: 1200px;
                                margin: 0 auto;
                            }
                            .hero-title {
                                font-size: 3rem;
                                color: var(--color-primary);
                                margin-bottom: 1.5rem;
                                line-height: 1.2;
                            }
                            .hero-text {
                                font-size: 1.25rem;
                                color: var(--color-neutral);
                                margin-bottom: 2rem;
                                line-height: 1.6;
                            }
                            .hero-buttons {
                                display: flex;
                                gap: 1rem;
                                flex-wrap: wrap;
                            }
                            .btn-primary, .btn-secondary {
                                display: inline-block;
                                padding: 1rem 2rem;
                                border-radius: 0.5rem;
                                text-decoration: none;
                                font-weight: 600;
                                transition: all 0.3s;
                            }
                            .btn-primary {
                                background: var(--color-primary);
                                color: white;
                            }
                            .btn-primary:hover {
                                background: var(--color-primary-dark);
                                transform: translateY(-2px);
                            }
                            .btn-secondary {
                                background: transparent;
                                color: var(--color-primary);
                                border: 2px solid var(--color-primary);
                            }
                            .btn-secondary:hover {
                                background: var(--color-primary);
                                color: white;
                            }
                            .hero-visual {
                                width: 100%;
                                height: 400px;
                                border-radius: 1rem;
                            }
                        `
                    }
                ];
                
                // Dans une vraie app, charger depuis l'API
                try {
                    const response = await fetch('/api/templates');
                    if (response.ok) {
                        const apiTemplates = await response.json();
                        this.templates = [...this.templates, ...apiTemplates];
                    }
                } catch (error) {
                    console.log('Utilisation des templates locaux');
                }
            }
            
            async loadSections() {
                // Sections de démonstration
                this.sections = [
                    {
                        id: 'hero-video',
                        name: 'Hero avec Vidéo',
                        category: 'Heroes',
                        html: `
                            <section class="hero-video section-container" data-section-id="hero-video">
                                <div class="video-bg">
                                    <div class="video-overlay"></div>
                                    <div class="video-placeholder image-placeholder" onclick="comfyCMS.uploadVideo(this)">
                                        <svg class="image-placeholder-icon" viewBox="0 0 24 24">
                                            <polygon points="23 7 16 12 23 17 23 7"/>
                                            <rect x="1" y="5" width="15" height="14" rx="2" ry="2"/>
                                        </svg>
                                        <p class="image-placeholder-text">Cliquez pour ajouter une vidéo</p>
                                    </div>
                                </div>
                                <div class="hero-content">
                                    <h1 class="editable">Titre Principal</h1>
                                    <p class="editable">Sous-titre accrocheur</p>
                                    <a href="#" class="cta-button editable editable-link">Call to Action</a>
                                </div>
                            </section>
                        `,
                        css: `
                            .hero-video { 
                                position: relative; 
                                height: 100vh; 
                                overflow: hidden;
                                display: flex;
                                align-items: center;
                                justify-content: center;
                            }
                            .video-bg { 
                                position: absolute; 
                                top: 0; 
                                left: 0; 
                                width: 100%; 
                                height: 100%; 
                            }
                            .video-overlay { 
                                position: absolute; 
                                top: 0; 
                                left: 0; 
                                width: 100%; 
                                height: 100%; 
                                background: rgba(0,0,0,0.5); 
                            }
                            .video-placeholder {
                                width: 100%;
                                height: 100%;
                                background: #1a1a1a;
                            }
                            .hero-video .hero-content { 
                                position: relative; 
                                z-index: 1; 
                                text-align: center;
                                color: white;
                                padding: 2rem;
                            }
                            .hero-video h1 { 
                                font-size: 4rem; 
                                margin-bottom: 1rem;
                                font-weight: 700;
                            }
                            .hero-video p { 
                                font-size: 1.5rem; 
                                margin-bottom: 2rem;
                                color: rgba(255,255,255,0.9);
                            }
                            .hero-video .cta-button { 
                                background: white; 
                                color: var(--color-primary); 
                                padding: 1rem 2rem; 
                                font-size: 1.1rem; 
                                border-radius: 0.5rem; 
                                text-decoration: none;
                                display: inline-block;
                                font-weight: 600;
                                transition: all 0.3s;
                            }
                            .hero-video .cta-button:hover {
                                transform: translateY(-2px);
                                box-shadow: 0 8px 20px rgba(255,255,255,0.3);
                            }
                        `
                    },
                    {
                        id: 'features-grid',
                        name: 'Grille de Features',
                        category: 'Features',
                        html: `
                            <section class="features-section section-container" data-section-id="features-grid">
                                <div class="container">
                                    <h2 class="section-title editable">Nos Services</h2>
                                    <p class="section-subtitle editable">Découvrez ce que nous pouvons faire pour vous</p>
                                    <div class="features-grid">
                                        <div class="feature-card">
                                            <div class="feature-icon">
                                                <svg viewBox="0 0 24 24" width="48" height="48">
                                                    <path fill="currentColor" d="M13 9h5.5L13 3.5V9M6 2h8l6 6v12a2 2 0 0 1-2 2H6a2 2 0 0 1-2-2V4c0-1.11.89-2 2-2m9 16v-2H6v2h9m3-4v-2H6v2h12z"/>
                                                </svg>
                                            </div>
                                            <h3 class="editable">Design Moderne</h3>
                                            <p class="editable">Créations uniques et personnalisées pour votre marque</p>
                                        </div>
                                        <div class="feature-card">
                                            <div class="feature-icon">
                                                <svg viewBox="0 0 24 24" width="48" height="48">
                                                    <path fill="currentColor" d="M12 2C6.48 2 2 6.48 2 12s4.48 10 10 10 10-4.48 10-10S17.52 2 12 2zm-2 15l-5-5 1.41-1.41L10 14.17l7.59-7.59L19 8l-9 9z"/>
                                                </svg>
                                            </div>
                                            <h3 class="editable">Qualité Premium</h3>
                                            <p class="editable">Excellence et attention aux détails garanties</p>
                                        </div>
                                        <div class="feature-card">
                                            <div class="feature-icon">
                                                <svg viewBox="0 0 24 24" width="48" height="48">
                                                    <path fill="currentColor" d="M12 1L3 5v6c0 5.55 3.84 10.74 9 12 5.16-1.26 9-6.45 9-12V5l-9-4z"/>
                                                </svg>
                                            </div>
                                            <h3 class="editable">Support 24/7</h3>
                                            <p class="editable">Une équipe dédiée à votre service en permanence</p>
                                        </div>
                                    </div>
                                </div>
                            </section>
                        `,
                        css: `
                            .features-section { 
                                padding: 5rem 2rem; 
                                background: var(--color-background-alt);
                            }
                            .features-section .container {
                                max-width: 1200px;
                                margin: 0 auto;
                            }
                            .section-title { 
                                text-align: center; 
                                font-size: 2.5rem; 
                                margin-bottom: 1rem;
                                color: var(--color-primary);
                                font-weight: 700;
                            }
                            .section-subtitle {
                                text-align: center;
                                font-size: 1.2rem;
                                color: var(--color-neutral);
                                margin-bottom: 3rem;
                            }
                            .features-grid { 
                                display: grid; 
                                grid-template-columns: repeat(auto-fit, minmax(300px, 1fr)); 
                                gap: 2rem;
                            }
                            .feature-card { 
                                text-align: center; 
                                padding: 2rem; 
                                background: var(--color-background); 
                                border-radius: 1rem; 
                                box-shadow: 0 4px 6px rgba(0,0,0,0.1);
                                transition: all 0.3s;
                            }
                            .feature-card:hover {
                                transform: translateY(-5px);
                                box-shadow: 0 8px 20px rgba(0,0,0,0.15);
                            }
                            .feature-icon { 
                                margin-bottom: 1.5rem;
                                color: var(--color-primary);
                            }
                            .feature-card h3 { 
                                font-size: 1.5rem; 
                                margin-bottom: 1rem;
                                color: var(--color-primary);
                            }
                            .feature-card p { 
                                color: var(--color-neutral);
                                line-height: 1.6;
                            }
                        `
                    },
                    {
                        id: 'gallery-animated',
                        name: 'Galerie Animée',
                        category: 'Galleries',
                        html: `
                            <section class="gallery-section section-container" data-section-id="gallery-animated">
                                <div class="container">
                                    <h2 class="section-title editable">Notre Portfolio</h2>
                                    <div class="gallery-grid">
                                        <div class="gallery-item">
                                            <div class="image-placeholder" onclick="comfyCMS.uploadImage(this)">
                                                <svg class="image-placeholder-icon" viewBox="0 0 24 24">
                                                    <rect x="3" y="3" width="18" height="18" rx="2" ry="2"/>
                                                    <circle cx="8.5" cy="8.5" r="1.5"/>
                                                    <polyline points="21 15 16 10 5 21"/>
                                                </svg>
                                                <p class="image-placeholder-text">Ajouter une image</p>
                                            </div>
                                            <div class="gallery-overlay">
                                                <p class="gallery-caption editable">Projet 1</p>
                                            </div>
                                        </div>
                                        <div class="gallery-item">
                                            <div class="image-placeholder" onclick="comfyCMS.uploadImage(this)">
                                                <svg class="image-placeholder-icon" viewBox="0 0 24 24">
                                                    <rect x="3" y="3" width="18" height="18" rx="2" ry="2"/>
                                                    <circle cx="8.5" cy="8.5" r="1.5"/>
                                                    <polyline points="21 15 16 10 5 21"/>
                                                </svg>
                                                <p class="image-placeholder-text">Ajouter une image</p>
                                            </div>
                                            <div class="gallery-overlay">
                                                <p class="gallery-caption editable">Projet 2</p>
                                            </div>
                                        </div>
                                        <div class="gallery-item">
                                            <div class="image-placeholder" onclick="comfyCMS.uploadImage(this)">
                                                <svg class="image-placeholder-icon" viewBox="0 0 24 24">
                                                    <rect x="3" y="3" width="18" height="18" rx="2" ry="2"/>
                                                    <circle cx="8.5" cy="8.5" r="1.5"/>
                                                    <polyline points="21 15 16 10 5 21"/>
                                                </svg>
                                                <p class="image-placeholder-text">Ajouter une image</p>
                                            </div>
                                            <div class="gallery-overlay">
                                                <p class="gallery-caption editable">Projet 3</p>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </section>
                        `,
                        css: `
                            .gallery-section {
                                padding: 5rem 2rem;
                                background: var(--color-background);
                            }
                            .gallery-section .container {
                                max-width: 1200px;
                                margin: 0 auto;
                            }
                            .gallery-grid {
                                display: grid;
                                grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
                                gap: 2rem;
                                margin-top: 3rem;
                            }
                            .gallery-item {
                                position: relative;
                                aspect-ratio: 1;
                                border-radius: 1rem;
                                overflow: hidden;
                                cursor: pointer;
                                transition: all 0.3s;
                            }
                            .gallery-item:hover {
                                transform: scale(1.05);
                                box-shadow: 0 10px 30px rgba(0,0,0,0.2);
                            }
                            .gallery-item .image-placeholder {
                                width: 100%;
                                height: 100%;
                                background: linear-gradient(135deg, #9b87f5 0%, #7e69ab 100%);
                            }
                            .gallery-overlay {
                                position: absolute;
                                top: 0;
                                left: 0;
                                right: 0;
                                bottom: 0;
                                background: linear-gradient(to bottom, transparent 0%, rgba(0,0,0,0.8) 100%);
                                opacity: 0;
                                transition: opacity 0.3s;
                                display: flex;
                                align-items: flex-end;
                                padding: 1.5rem;
                            }
                            .gallery-item:hover .gallery-overlay {
                                opacity: 1;
                            }
                            .gallery-caption {
                                color: white;
                                font-size: 1.2rem;
                                font-weight: 600;
                            }
                        `
                    },
                    {
                        id: 'testimonials-slider',
                        name: 'Témoignages Slider',
                        category: 'Testimonials',
                        html: `
                            <section class="testimonials-section section-container" data-section-id="testimonials-slider">
                                <div class="container">
                                    <h2 class="section-title editable">Ce que nos clients disent</h2>
                                    <div class="testimonials-slider">
                                        <div class="testimonial-card active">
                                            <div class="testimonial-content">
                                                <p class="testimonial-text editable">"Service exceptionnel ! L'équipe a dépassé toutes nos attentes. Je recommande vivement leurs services."</p>
                                                <div class="testimonial-author">
                                                    <div class="author-avatar image-placeholder" onclick="comfyCMS.uploadImage(this)" style="width: 60px; height: 60px;">
                                                        <svg class="image-placeholder-icon" viewBox="0 0 24 24" style="width: 24px; height: 24px;">
                                                            <path d="M12 2C6.48 2 2 6.48 2 12s4.48 10 10 10 10-4.48 10-10S17.52 2 12 2zm0 3c1.66 0 3 1.34 3 3s-1.34 3-3 3-3-1.34-3-3 1.34-3 3-3zm0 14.2c-2.5 0-4.71-1.28-6-3.22.03-1.99 4-3.08 6-3.08 1.99 0 5.97 1.09 6 3.08-1.29 1.94-3.5 3.22-6 3.22z"/>
                                                        </svg>
                                                    </div>
                                                    <div class="author-info">
                                                        <h4 class="author-name editable">Marie Dupont</h4>
                                                        <p class="author-title editable">CEO, TechCorp</p>
                                                    </div>
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </section>
                        `,
                        css: `
                            .testimonials-section {
                                padding: 5rem 2rem;
                                background: var(--color-background-alt);
                            }
                            .testimonials-section .container {
                                max-width: 800px;
                                margin: 0 auto;
                            }
                            .testimonials-slider {
                                margin-top: 3rem;
                            }
                            .testimonial-card {
                                background: var(--color-background);
                                padding: 3rem;
                                border-radius: 1rem;
                                box-shadow: 0 4px 20px rgba(0,0,0,0.1);
                                text-align: center;
                            }
                            .testimonial-text {
                                font-size: 1.25rem;
                                line-height: 1.8;
                                color: var(--color-neutral);
                                margin-bottom: 2rem;
                                font-style: italic;
                            }
                            .testimonial-author {
                                display: flex;
                                align-items: center;
                                justify-content: center;
                                gap: 1rem;
                            }
                            .author-avatar {
                                width: 60px;
                                height: 60px;
                                border-radius: 50%;
                                overflow: hidden;
                            }
                            .author-info {
                                text-align: left;
                            }
                            .author-name {
                                font-size: 1.1rem;
                                color: var(--color-primary);
                                margin-bottom: 0.25rem;
                            }
                            .author-title {
                                font-size: 0.9rem;
                                color: var(--color-neutral);
                            }
                        `
                    },
                    {
                        id: 'contact-form',
                        name: 'Formulaire de Contact',
                        category: 'Contact',
                        html: `
                            <section class="contact-section section-container" data-section-id="contact-form">
                                <div class="container">
                                    <h2 class="section-title editable">Contactez-nous</h2>
                                    <p class="section-subtitle editable">Nous serions ravis d'échanger avec vous</p>
                                    <div class="contact-grid">
                                        <div class="contact-info">
                                            <div class="info-item">
                                                <h3 class="editable">Email</h3>
                                                <p class="editable">contact@example.com</p>
                                            </div>
                                            <div class="info-item">
                                                <h3 class="editable">Téléphone</h3>
                                                <p class="editable">+33 1 23 45 67 89</p>
                                            </div>
                                            <div class="info-item">
                                                <h3 class="editable">Adresse</h3>
                                                <p class="editable">123 Rue Example, 75001 Paris</p>
                                            </div>
                                        </div>
                                        <form class="contact-form">
                                            <input type="text" placeholder="Votre nom" class="form-input">
                                            <input type="email" placeholder="Votre email" class="form-input">
                                            <textarea placeholder="Votre message" rows="5" class="form-input"></textarea>
                                            <button type="submit" class="form-submit editable">Envoyer</button>
                                        </form>
                                    </div>
                                </div>
                            </section>
                        `,
                        css: `
                            .contact-section {
                                padding: 5rem 2rem;
                                background: var(--color-background);
                            }
                            .contact-section .container {
                                max-width: 1200px;
                                margin: 0 auto;
                            }
                            .contact-grid {
                                display: grid;
                                grid-template-columns: 1fr 2fr;
                                gap: 4rem;
                                margin-top: 3rem;
                            }
                            .info-item {
                                margin-bottom: 2rem;
                            }
                            .info-item h3 {
                                color: var(--color-primary);
                                margin-bottom: 0.5rem;
                            }
                            .info-item p {
                                color: var(--color-neutral);
                            }
                            .contact-form {
                                display: flex;
                                flex-direction: column;
                                gap: 1rem;
                            }
                            .form-input {
                                padding: 1rem;
                                border: 2px solid var(--color-background-alt);
                                border-radius: 0.5rem;
                                font-size: 1rem;
                                transition: border-color 0.3s;
                            }
                            .form-input:focus {
                                outline: none;
                                border-color: var(--color-primary);
                            }
                            .form-submit {
                                background: var(--color-primary);
                                color: white;
                                padding: 1rem 2rem;
                                border: none;
                                border-radius: 0.5rem;
                                font-size: 1.1rem;
                                font-weight: 600;
                                cursor: pointer;
                                transition: all 0.3s;
                            }
                            .form-submit:hover {
                                background: var(--color-primary-dark);
                                transform: translateY(-2px);
                            }
                        `
                    },
                    {
                        id: 'pricing-table',
                        name: 'Tableau de Prix',
                        category: 'Features',
                        html: `
                            <section class="pricing-section section-container" data-section-id="pricing-table">
                                <div class="container">
                                    <h2 class="section-title editable">Nos Offres</h2>
                                    <p class="section-subtitle editable">Choisissez le plan qui vous convient le mieux.</p>
                                    <div class="pricing-grid">
                                        <div class="pricing-card">
                                            <h3 class="plan-name editable">Basique</h3>
                                            <div class="plan-price editable">19€<span class="plan-period">/mois</span></div>
                                            <ul class="plan-features">
                                                <li class="editable">Feature 1</li>
                                                <li class="editable">Feature 2</li>
                                                <li class="editable">Feature 3</li>
                                            </ul>
                                            <a href="#" class="cta-button editable editable-link">Choisir ce plan</a>
                                        </div>
                                        <div class="pricing-card popular">
                                            <div class="popular-badge">Populaire</div>
                                            <h3 class="plan-name editable">Pro</h3>
                                            <div class="plan-price editable">49€<span class="plan-period">/mois</span></div>
                                            <ul class="plan-features">
                                                <li class="editable">Tout du plan Basique</li>
                                                <li class="editable">Feature 4</li>
                                                <li class="editable">Feature 5</li>
                                            </ul>
                                            <a href="#" class="cta-button editable editable-link">Choisir ce plan</a>
                                        </div>
                                        <div class="pricing-card">
                                            <h3 class="plan-name editable">Entreprise</h3>
                                            <div class="plan-price editable">Sur devis</div>
                                             <ul class="plan-features">
                                                <li class="editable">Tout du plan Pro</li>
                                                <li class="editable">Support dédié</li>
                                                <li class="editable">Intégrations custom</li>
                                            </ul>
                                            <a href="#" class="cta-button editable editable-link">Nous contacter</a>
                                        </div>
                                    </div>
                                </div>
                            </section>
                        `,
                        css: `
                            .pricing-section { padding: 5rem 2rem; background: var(--color-background-alt); }
                            .pricing-section .container { max-width: 1200px; margin: 0 auto; text-align: center; }
                            .pricing-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(300px, 1fr)); gap: 2rem; margin-top: 3rem; text-align: left; }
                            .pricing-card { background: var(--color-background); border-radius: 1rem; padding: 2.5rem; box-shadow: 0 4px 6px rgba(0,0,0,0.05); transition: all 0.3s; position: relative; border: 2px solid transparent; }
                            .pricing-card:hover { transform: translateY(-10px); box-shadow: 0 10px 30px rgba(0,0,0,0.1); }
                            .pricing-card.popular { border-color: var(--color-primary); }
                            .popular-badge { position: absolute; top: -15px; left: 50%; transform: translateX(-50%); background: var(--color-primary); color: white; padding: 0.5rem 1rem; border-radius: 20px; font-size: 0.9rem; font-weight: 600; }
                            .plan-name { font-size: 1.5rem; color: var(--color-primary); margin-bottom: 1rem; }
                            .plan-price { font-size: 3rem; font-weight: 700; color: var(--dark); margin-bottom: 1.5rem; }
                            .plan-period { font-size: 1rem; font-weight: 400; color: var(--color-neutral); margin-left: 0.5rem; }
                            .plan-features { list-style: none; margin: 0 0 2rem 0; padding: 0; }
                            .plan-features li { margin-bottom: 1rem; color: var(--color-neutral); display: flex; align-items: center; gap: 0.5rem; }
                            .plan-features li::before { content: '✓'; color: var(--color-primary); font-weight: bold; }
                            .pricing-card .cta-button { display: block; text-align: center; background: var(--color-primary); color: white; padding: 1rem; border-radius: 0.5rem; text-decoration: none; font-weight: 600; transition: background 0.3s; }
                            .pricing-card .cta-button:hover { background: var(--color-primary-dark); }
                            .pricing-card:not(.popular) .cta-button { background: transparent; color: var(--color-primary); border: 2px solid var(--color-primary); }
                            .pricing-card:not(.popular) .cta-button:hover { background: var(--color-primary); color: white; }
                        `
                    }
                ];
                
                // Créer la liste complète des sections (templates + standalone)
                this.allSections = [...this.sections];
                
                // Ajouter les sections des templates
                this.templates.forEach(template => {
                    if (template.sections) {
                        template.sections.forEach(sectionId => {
                            if (!this.allSections.find(s => s.id === sectionId)) {
                                // Extraire les sections du template
                                const sectionElement = this.extractSectionFromTemplate(template, sectionId);
                                if (sectionElement) {
                                    this.allSections.push(sectionElement);
                                }
                            }
                        });
                    }
                });
            }
            
            extractSectionFromTemplate(template, sectionId) {
                // Parser le HTML du template pour extraire une section spécifique
                const tempDiv = document.createElement('div');
                tempDiv.innerHTML = template.html;
                const sectionEl = tempDiv.querySelector(`[data-section-id="${sectionId}"]`);
                
                if (sectionEl) {
                    // Extraire les styles spécifiques à cette section
                    const sectionStyles = this.extractSectionStyles(template.css, sectionId);
                    
                    return {
                        id: sectionId,
                        name: this.formatSectionName(sectionId),
                        category: 'Template Sections',
                        html: sectionEl.outerHTML,
                        css: sectionStyles
                    };
                }
                
                return null;
            }
            
            extractSectionStyles(css, sectionId) {
                // Extraire les styles pertinents pour une section
                const lines = css.split('\n');
                const relevantLines = [];
                let inRelevantRule = false;
                
                lines.forEach(line => {
                    if (line.includes(`.${sectionId}`) || line.includes(`[data-section-id="${sectionId}"]`)) {
                        inRelevantRule = true;
                    }
                    
                    if (inRelevantRule) {
                        relevantLines.push(line);
                        
                        if (line.includes('}')) {
                            inRelevantRule = false;
                        }
                    }
                });
                
                return relevantLines.join('\n');
            }
            
            formatSectionName(sectionId) {
                // Convertir section-id en Section Name
                return sectionId
                    .split('-')
                    .map(word => word.charAt(0).toUpperCase() + word.slice(1))
                    .join(' ');
            }
            
            // Gestion des templates
            loadTemplatesTab() {
                const searchTerm = document.getElementById('search-input')?.value.toLowerCase() || '';
                
                // Grouper par catégorie
                const categories = [...new Set(this.templates.map(t => t.category))];
                
                let content = '';
                
                categories.forEach(category => {
                    const categoryTemplates = this.templates.filter(t => t.category === category);
                    const filteredTemplates = categoryTemplates.filter(t => 
                        searchTerm === '' || 
                        t.name.toLowerCase().includes(searchTerm) ||
                        t.category.toLowerCase().includes(searchTerm) ||
                        t.description.toLowerCase().includes(searchTerm)
                    );
                    
                    if (filteredTemplates.length > 0) {
                        content += `
                            <div style="margin-bottom: 2rem;">
                                <h3 class="category-header">${category}</h3>
                                <div class="items-grid">
                                    ${filteredTemplates.map(template => `
                                        <div class="item-card" onclick="comfyCMS.selectTemplate('${template.id}')">
                                            <div class="item-preview">
                                                ${template.preview ? 
                                                    `<img src="${template.preview}" alt="${template.name}">` :
                                                    `<div style="background: linear-gradient(135deg, var(--primary) 0%, var(--primary-dark) 100%); width: 100%; height: 100%;"></div>`
                                                }
                                                <span class="item-badge">${template.category}</span>
                                            </div>
                                            <div class="item-info">
                                                <h3 class="item-name">${this.highlightSearch(template.name, searchTerm)}</h3>
                                                <p class="item-description">${this.highlightSearch(template.description, searchTerm)}</p>
                                            </div>
                                        </div>
                                    `).join('')}
                                </div>
                            </div>
                        `;
                    }
                });
                
                if (content === '') {
                    content = `
                        <div class="no-results">
                            <p>Aucun template trouvé pour "${searchTerm}"</p>
                        </div>
                    `;
                }
                
                document.getElementById('sidebar-content').innerHTML = content;
            }
            
            highlightSearch(text, searchTerm) {
                if (!searchTerm) return text;
                
                const regex = new RegExp(`(${searchTerm})`, 'gi');
                return text.replace(regex, '<span class="highlight">$1</span>');
            }
            
            selectTemplate(templateId) {
                const template = this.templates.find(t => t.id === templateId);
                if (!template) return;
                
                this.currentTemplate = template;
                
                // Appliquer le template
                const previewContent = document.getElementById('preview-content');
                previewContent.innerHTML = template.html;
                
                // Appliquer les styles avec les variables CSS
                this.applyTemplateStyles(template);
                
                // Ajouter les contrôles de section
                this.addSectionControls();
                
                // Appliquer la palette de couleurs par défaut
                this.applyColorPalette(0);
                
                // Rendre tout éditable
                this.makeEverythingEditable();
                
                // Sauvegarder l'historique
                this.saveHistory();
                
                this.showToast(`Template "${template.name}" appliqué!`, 'success');
            }
            
            applyTemplateStyles(template) {
                let css = template.css;
                
                // Ajouter les variables CSS pour les couleurs
                const rootStyles = `
                    :root {
                        --color-primary: #9b87f5;
                        --color-primary-dark: #7e69ab;
                        --color-secondary: #ff8e6e;
                        --color-accent: #ffc85c;
                        --color-neutral: #8e9196;
                        --color-background: #ffffff;
                        --color-background-alt: #f7f5ff;
                    }
                `;
                
                const styleTag = document.getElementById('template-styles') || document.createElement('style');
                styleTag.id = 'template-styles';
                styleTag.textContent = rootStyles + '\n' + css;
                document.head.appendChild(styleTag);
            }
            
            changeTemplate() {
                this.showModal('Changer de Template', `
                    <div class="modal-message">
                        <p style="margin-bottom: 1rem;">Sélectionnez un nouveau template :</p>
                        <div class="items-grid" style="max-height: 400px; overflow-y: auto;">
                            ${this.templates.map(template => `
                                <div class="item-card" onclick="comfyCMS.applyNewTemplate('${template.id}')" style="cursor: pointer;">
                                    <div class="item-preview" style="height: 100px;">
                                        ${template.preview ? 
                                            `<img src="${template.preview}" alt="${template.name}">` :
                                            `<div style="background: linear-gradient(135deg, var(--primary) 0%, var(--primary-dark) 100%); width: 100%; height: 100%;"></div>`
                                        }
                                    </div>
                                    <div class="item-info">
                                        <h4 class="item-name">${template.name}</h4>
                                    </div>
                                </div>
                            `).join('')}
                        </div>
                    </div>
                `, null, false);
            }
            
            applyNewTemplate(templateId) {
                if (confirm('Attention : changer de template remplacera tout le contenu actuel. Continuer ?')) {
                    this.selectTemplate(templateId);
                    this.closeModal();
                }
            }
            
            // Gestion des sections
            loadSectionsTab() {
                const searchTerm = document.getElementById('search-input')?.value.toLowerCase() || '';
                
                // Grouper par catégorie
                const categories = [...new Set(this.allSections.map(s => s.category))];
                
                let content = '';
                
                categories.forEach(category => {
                    const categorySections = this.allSections.filter(s => s.category === category);
                    const filteredSections = categorySections.filter(s => 
                        searchTerm === '' ||
                        s.name.toLowerCase().includes(searchTerm) ||
                        s.category.toLowerCase().includes(searchTerm)
                    );
                    
                    if (filteredSections.length > 0) {
                        content += `
                            <div style="margin-bottom: 2rem;">
                                <h3 class="category-header">${category}</h3>
                                <div class="sections-list">
                                    ${filteredSections.map(section => `
                                        <div class="section-item" draggable="true" data-section-id="${section.id}">
                                            <span class="section-handle">
                                                <svg class="icon icon-sm" viewBox="0 0 24 24">
                                                    <path d="M3 15h18v-2H3v2zm0 4h18v-2H3v2zm0-8h18V9H3v2zm0-6v2h18V5H3z"/>
                                                </svg>
                                            </span>
                                            <div style="flex: 1;">
                                                <h4 style="font-weight: 600; margin-bottom: 0.25rem;">${this.highlightSearch(section.name, searchTerm)}</h4>
                                                <p style="font-size: var(--text-xs); color: var(--gray);">Glissez pour ajouter</p>
                                            </div>
                                            <button class="btn-icon" onclick="comfyCMS.addSection('${section.id}')" title="Ajouter">
                                                <svg class="icon icon-sm" viewBox="0 0 24 24">
                                                    <path d="M12 5v14m-7-7h14"/>
                                                </svg>
                                            </button>
                                        </div>
                                    `).join('')}
                                </div>
                            </div>
                        `;
                    }
                });
                
                if (content === '') {
                    content = `
                        <div class="no-results">
                            <p>Aucune section trouvée pour "${searchTerm}"</p>
                        </div>
                    `;
                }
                
                document.getElementById('sidebar-content').innerHTML = content;
                
                // Activer le drag & drop pour les sections
                this.setupSectionDragAndDrop();
            }
            
            setupSectionDragAndDrop() {
                const sectionItems = document.querySelectorAll('.section-item[draggable="true"]');
                
                sectionItems.forEach(item => {
                    item.addEventListener('dragstart', (e) => {
                        e.dataTransfer.effectAllowed = 'copy';
                        e.dataTransfer.setData('sectionId', item.dataset.sectionId);
                        item.classList.add('dragging');
                    });
                    
                    item.addEventListener('dragend', (e) => {
                        item.classList.remove('dragging');
                    });
                });
                
                // Permettre le drop dans la zone de preview
                const previewContent = document.getElementById('preview-content');
                
                previewContent.addEventListener('dragover', (e) => {
                    e.preventDefault();
                    e.dataTransfer.dropEffect = 'copy';
                });
                
                previewContent.addEventListener('drop', (e) => {
                    e.preventDefault();
                    const sectionId = e.dataTransfer.getData('sectionId');
                    if (sectionId) {
                        this.addSection(sectionId);
                    }
                });
            }
            
            addSection(sectionId) {
                const section = this.allSections.find(s => s.id === sectionId);
                if (!section) return;
                
                const previewContent = document.getElementById('preview-content');
                
                // Créer un conteneur temporaire
                const tempDiv = document.createElement('div');
                tempDiv.innerHTML = section.html;
                
                // S'assurer que la section a les bons attributs
                const sectionEl = tempDiv.firstElementChild;
                if (!sectionEl.classList.contains('section-container')) {
                    sectionEl.classList.add('section-container');
                }
                sectionEl.setAttribute('data-section-id', `${sectionId}-${Date.now()}`);
                
                // Ajouter la section
                previewContent.appendChild(sectionEl);
                
                // Ajouter les styles
                const currentStyles = document.getElementById('template-styles');
                if (currentStyles && section.css) {
                    currentStyles.textContent += '\n' + section.css;
                }
                
                // Ajouter les contrôles
                this.addSectionControls();
                
                // Rendre éditable
                this.makeEverythingEditable();
                
                // Sauvegarder
                this.saveHistory();
                
                this.showToast(`Section "${section.name}" ajoutée!`, 'success');
            }
            
            addSectionControls() {
                const sections = document.querySelectorAll('.section-container');
                
                sections.forEach(section => {
                    // Vérifier si les contrôles existent déjà
                    if (section.querySelector('.section-controls')) return;
                    
                    const controls = document.createElement('div');
                    controls.className = 'section-controls';
                    controls.innerHTML = `
                        <button class="section-control-btn" onclick="comfyCMS.moveSection(this.closest('.section-container'), 'up')" title="Monter">
                            <svg class="icon icon-sm" viewBox="0 0 24 24">
                                <path d="M12 8l-6 6 1.41 1.41L12 10.83l4.59 4.58L18 14z"/>
                            </svg>
                        </button>
                        <button class="section-control-btn" onclick="comfyCMS.moveSection(this.closest('.section-container'), 'down')" title="Descendre">
                            <svg class="icon icon-sm" viewBox="0 0 24 24">
                                <path d="M16.59 8.59L12 13.17 7.41 8.59 6 10l6 6 6-6z"/>
                            </svg>
                        </button>
                        <button class="section-control-btn" onclick="comfyCMS.duplicateSection(this.closest('.section-container'))" title="Dupliquer">
                            <svg class="icon icon-sm" viewBox="0 0 24 24">
                                <path d="M16 1H4c-1.1 0-2 .9-2 2v14h2V3h12V1zm3 4H8c-1.1 0-2 .9-2 2v14c0 1.1.9 2 2 2h11c1.1 0 2-.9 2-2V7c0-1.1-.9-2-2-2zm0 16H8V7h11v14z"/>
                            </svg>
                        </button>
                        <button class="section-control-btn" onclick="comfyCMS.deleteSection(this.closest('.section-container'))" title="Supprimer">
                            <svg class="icon icon-sm" viewBox="0 0 24 24">
                                <path d="M6 19c0 1.1.9 2 2 2h8c1.1 0 2-.9 2-2V7H6v12zM19 4h-3.5l-1-1h-5l-1 1H5v2h14V4z"/>
                            </svg>
                        </button>
                    `;
                    
                    section.appendChild(controls);
                    
                    // Ajouter handle pour drag
                    const handle = document.createElement('div');
                    handle.className = 'section-handle';
                    handle.innerHTML = `
                        <svg class="icon" viewBox="0 0 24 24">
                            <path d="M3 15h18v-2H3v2zm0 4h18v-2H3v2zm0-8h18V9H3v2zm0-6v2h18V5H3z"/>
                        </svg>
                    `;
                    section.insertBefore(handle, section.firstChild);
                });
            }
            
            moveSection(section, direction) {
                const sibling = direction === 'up' ? section.previousElementSibling : section.nextElementSibling;
                if (!sibling || !sibling.classList.contains('section-container')) return;
                
                if (direction === 'up') {
                    section.parentNode.insertBefore(section, sibling);
                } else {
                    section.parentNode.insertBefore(sibling, section);
                }
                
                this.saveHistory();
                this.showToast('Section déplacée', 'info');
            }
            
            duplicateSection(section) {
                const clone = section.cloneNode(true);
                clone.setAttribute('data-section-id', `${section.getAttribute('data-section-id')}-copy-${Date.now()}`);
                section.parentNode.insertBefore(clone, section.nextSibling);
                
                this.addSectionControls();
                this.makeEverythingEditable();
                this.saveHistory();
                
                this.showToast('Section dupliquée', 'success');
            }
            
            deleteSection(section) {
                if (confirm('Supprimer cette section ?')) {
                    section.remove();
                    this.saveHistory();
                    this.showToast('Section supprimée', 'info');
                }
            }
            
            // Gestion des clients
            loadClientsTab() {
                const clients = this.clientManager.getClients();
                const searchTerm = document.getElementById('search-input')?.value.toLowerCase() || '';
                const filteredClients = clients.filter(c => 
                    c.name.toLowerCase().includes(searchTerm) ||
                    c.email.toLowerCase().includes(searchTerm) ||
                    c.company?.toLowerCase().includes(searchTerm)
                );
                
                const content = `
                    <div style="margin-bottom: 1rem;">
                        <button class="btn btn-primary" style="width: 100%;" onclick="comfyCMS.showAddClientModal()">
                            <svg class="icon icon-sm" viewBox="0 0 24 24">
                                <path d="M19 13h-6v6h-2v-6H5v-2h6V5h2v6h6v2z"/>
                            </svg>
                            Nouveau Client
                        </button>
                    </div>
                    
                    <div class="client-list">
                        ${filteredClients.map(client => `
                            <div class="client-item" onclick="comfyCMS.showClientDetails('${client.id}')">
                                <h4 class="client-name">${this.highlightSearch(client.name, searchTerm)}</h4>
                                <p class="client-info">${this.highlightSearch(client.email, searchTerm)}</p>
                                ${client.company ? `<p class="client-info">${this.highlightSearch(client.company, searchTerm)}</p>` : ''}
                            </div>
                        `).join('')}
                    </div>
                    
                    ${filteredClients.length === 0 ? `
                        <div class="no-results">
                            <p>${searchTerm ? `Aucun client trouvé pour "${searchTerm}"` : 'Aucun client enregistré'}</p>
                        </div>
                    ` : ''}
                `;
                
                document.getElementById('sidebar-content').innerHTML = content;
            }
            
            showAddClientModal() {
                this.showModal('Nouveau Client', `
                    <form id="client-form">
                        <div class="property-group">
                            <label class="property-label">Nom *</label>
                            <input type="text" class="property-input" name="name" required>
                        </div>
                        <div class="property-group">
                            <label class="property-label">Email *</label>
                            <input type="email" class="property-input" name="email" required>
                        </div>
                        <div class="property-group">
                            <label class="property-label">Téléphone</label>
                            <input type="tel" class="property-input" name="phone">
                        </div>
                        <div class="property-group">
                            <label class="property-label">Entreprise</label>
                            <input type="text" class="property-input" name="company">
                        </div>
                        <div class="property-group">
                            <label class="property-label">Adresse</label>
                            <textarea class="property-input" name="address" rows="3"></textarea>
                        </div>
                        <div class="property-group">
                            <label class="property-label">Notes</label>
                            <textarea class="property-input" name="notes" rows="3"></textarea>
                        </div>
                    </form>
                `, () => {
                    const form = document.getElementById('client-form');
                    const formData = new FormData(form);
                    const clientData = Object.fromEntries(formData);
                    
                    this.clientManager.addClient(clientData);
                    this.loadClientsTab();
                    this.closeModal();
                    this.showToast('Client ajouté avec succès!', 'success');
                });
            }
            
            showClientDetails(clientId) {
                const client = this.clientManager.getClient(clientId);
                if (!client) return;
                
                this.showModal(`Client : ${client.name}`, `
                    <div class="client-details">
                        <div class="property-group">
                            <label class="property-label">Email</label>
                            <p>${client.email}</p>
                        </div>
                        ${client.phone ? `
                            <div class="property-group">
                                <label class="property-label">Téléphone</label>
                                <p>${client.phone}</p>
                            </div>
                        ` : ''}
                        ${client.company ? `
                            <div class="property-group">
                                <label class="property-label">Entreprise</label>
                                <p>${client.company}</p>
                            </div>
                        ` : ''}
                        ${client.address ? `
                            <div class="property-group">
                                <label class="property-label">Adresse</label>
                                <p>${client.address}</p>
                            </div>
                        ` : ''}
                        ${client.notes ? `
                            <div class="property-group">
                                <label class="property-label">Notes</label>
                                <p>${client.notes}</p>
                            </div>
                        ` : ''}
                        
                        <div style="display: flex; gap: 1rem; margin-top: 2rem;">
                            <button class="btn btn-secondary" onclick="comfyCMS.editClient('${clientId}')">
                                <svg class="icon icon-sm" viewBox="0 0 24 24">
                                    <path d="M3 17.25V21h3.75L17.81 9.94l-3.75-3.75L3 17.25zM20.71 7.04c.39-.39.39-1.02 0-1.41l-2.34-2.34c-.39-.39-1.02-.39-1.41 0l-1.83 1.83 3.75 3.75 1.83-1.83z"/>
                                </svg>
                                Modifier
                            </button>
                            <button class="btn btn-secondary" onclick="comfyCMS.deleteClient('${clientId}')" style="color: #ef4444;">
                                <svg class="icon icon-sm" viewBox="0 0 24 24">
                                    <path d="M6 19c0 1.1.9 2 2 2h8c1.1 0 2-.9 2-2V7H6v12zM19 4h-3.5l-1-1h-5l-1 1H5v2h14V4z"/>
                                </svg>
                                Supprimer
                            </button>
                        </div>
                    </div>
                `, null, false);
            }
            
            editClient(clientId) {
                const client = this.clientManager.getClient(clientId);
                if (!client) return;
                
                this.showModal('Modifier Client', `
                    <form id="client-form">
                        <div class="property-group">
                            <label class="property-label">Nom *</label>
                            <input type="text" class="property-input" name="name" value="${client.name}" required>
                        </div>
                        <div class="property-group">
                            <label class="property-label">Email *</label>
                            <input type="email" class="property-input" name="email" value="${client.email}" required>
                        </div>
                        <div class="property-group">
                            <label class="property-label">Téléphone</label>
                            <input type="tel" class="property-input" name="phone" value="${client.phone || ''}">
                        </div>
                        <div class="property-group">
                            <label class="property-label">Entreprise</label>
                            <input type="text" class="property-input" name="company" value="${client.company || ''}">
                        </div>
                        <div class="property-group">
                            <label class="property-label">Adresse</label>
                            <textarea class="property-input" name="address" rows="3">${client.address || ''}</textarea>
                        </div>
                        <div class="property-group">
                            <label class="property-label">Notes</label>
                            <textarea class="property-input" name="notes" rows="3">${client.notes || ''}</textarea>
                        </div>
                    </form>
                `, () => {
                    const form = document.getElementById('client-form');
                    const formData = new FormData(form);
                    const clientData = Object.fromEntries(formData);
                    
                    this.clientManager.updateClient(clientId, clientData);
                    this.loadClientsTab();
                    this.closeModal();
                    this.showToast('Client modifié avec succès!', 'success');
                });
            }
            
            deleteClient(clientId) {
                if (confirm('Supprimer ce client ?')) {
                    this.clientManager.deleteClient(clientId);
                    this.loadClientsTab();
                    this.closeModal();
                    this.showToast('Client supprimé', 'info');
                }
            }
            
            // Gestion des assets
            loadAssetsTab() {
                const content = `
                    <div style="padding: 1rem;">
                        <div style="border: 3px dashed var(--primary-light); border-radius: var(--border-radius); padding: 3rem; text-align: center; cursor: pointer; transition: all var(--transition); background: var(--light-gray);"
                             onmouseover="this.style.borderColor='var(--primary)'; this.style.background='var(--primary-light)'"
                             onmouseout="this.style.borderColor='var(--primary-light)'; this.style.background='var(--light-gray)'"
                             onclick="document.getElementById('assets-upload').click()">
                            <svg class="icon icon-lg" viewBox="0 0 24 24" style="margin: 0 auto 1rem; color: var(--primary);">
                                <path d="M9 16h6v-6h4l-7-7-7 7h4zm-4 2h14v2H5z"/>
                            </svg>
                            <p style="color: var(--primary); margin-bottom: 0.5rem; font-weight: 600;">Glissez vos fichiers ici</p>
                            <p style="color: var(--gray); font-size: var(--text-sm);">ou cliquez pour parcourir</p>
                        </div>
                        <input type="file" id="assets-upload" style="display: none" accept="image/*,video/*" multiple onchange="comfyCMS.handleAssetsUpload(this)">
                        
                        <div class="gallery-grid" id="assets-gallery" style="margin-top: 2rem;">
                            <!-- Les assets seront affichés ici -->
                        </div>
                    </div>
                `;
                
                document.getElementById('sidebar-content').innerHTML = content;
                this.loadAssetsGallery();
            }
            
            loadAssetsGallery() {
                // Charger les assets depuis le localStorage ou l'API
                const assets = JSON.parse(localStorage.getItem('comfycms_assets') || '[]');
                const gallery = document.getElementById('assets-gallery');
                
                if (assets.length === 0) {
                    gallery.innerHTML = '<p style="text-align: center; color: var(--gray);">Aucun média uploadé</p>';
                    return;
                }
                
                gallery.innerHTML = assets.map(asset => `
                    <div class="gallery-item" onclick="comfyCMS.useAsset('${asset.url}')">
                        <img src="${asset.url}" alt="${asset.name}">
                        <div class="gallery-overlay">
                            <p class="gallery-caption">${asset.name}</p>
                        </div>
                    </div>
                `).join('');
            }
            
            handleAssetsUpload(input) {
                const files = Array.from(input.files);
                const assets = JSON.parse(localStorage.getItem('comfycms_assets') || '[]');
                
                files.forEach(file => {
                    const reader = new FileReader();
                    reader.onload = (e) => {
                        assets.push({
                            id: Date.now() + Math.random(),
                            name: file.name,
                            url: e.target.result,
                            type: file.type,
                            size: file.size
                        });
                        
                        localStorage.setItem('comfycms_assets', JSON.stringify(assets));
                        this.loadAssetsGallery();
                        this.showToast(`${file.name} uploadé!`, 'success');
                    };
                    reader.readAsDataURL(file);
                });
            }
            
            useAsset(url) {
                if (this.selectedElement?.classList.contains('image-placeholder')) {
                    this.replaceWithImage(this.selectedElement, url);
                } else {
                    // Copier l'URL dans le presse-papier
                    navigator.clipboard.writeText(url);
                    this.showToast('URL copiée dans le presse-papier!', 'info');
                }
            }
            
            // Édition et sélection
            selectElement(element) {
                // Désélectionner l'ancien
                if (this.selectedElement) {
                    this.selectedElement.classList.remove('editing');
                    const section = this.selectedElement.closest('.section-container');
                    if (section) section.classList.remove('selected');
                }
                
                // Sélectionner le nouveau
                this.selectedElement = element;
                element.classList.add('editing');
                
                // Sélectionner la section parent si elle existe
                const section = element.closest('.section-container');
                if (section) section.classList.add('selected');
                
                // Afficher les propriétés
                this.showElementProperties(element);
                
                // Positionner la toolbar si c'est du texte
                if (this.isTextElement(element)) {
                    this.positionFloatingToolbar(element);
                }
            }
            
            isTextElement(element) {
                const textTags = ['H1', 'H2', 'H3', 'H4', 'H5', 'H6', 'P', 'SPAN', 'DIV', 'LI', 'A'];
                return textTags.includes(element.tagName);
            }
            
            enableInlineEditing(element) {
                element.contentEditable = 'true';
                element.focus();
                
                // Sélectionner tout le texte
                const range = document.createRange();
                range.selectNodeContents(element);
                const selection = window.getSelection();
                selection.removeAllRanges();
                selection.addRange(range);
                
                // Sauvegarder au blur
                const saveEdit = () => {
                    element.contentEditable = 'false';
                    this.saveHistory();
                };
                
                element.addEventListener('blur', saveEdit, { once: true });
                
                // Permettre l'annulation avec Escape
                element.addEventListener('keydown', (e) => {
                    if (e.key === 'Escape') {
                        element.blur();
                    }
                });
            }
            
            editLink(linkElement) {
                const currentHref = linkElement.getAttribute('href') || '#';
                
                this.showModal('Modifier le lien', `
                    <div class="property-group">
                        <label class="property-label">URL du lien</label>
                        <input type="text" class="property-input" id="link-url" value="${currentHref}" placeholder="https://...">
                    </div>
                    <div class="property-group">
                        <label class="property-label">Texte du lien</label>
                        <input type="text" class="property-input" id="link-text" value="${linkElement.textContent}">
                    </div>
                    <div class="property-group">
                        <label class="property-label">
                            <input type="checkbox" id="link-target" ${linkElement.target === '_blank' ? 'checked' : ''}>
                            Ouvrir dans un nouvel onglet
                        </label>
                    </div>
                `, () => {
                    const url = document.getElementById('link-url').value;
                    const text = document.getElementById('link-text').value;
                    const target = document.getElementById('link-target').checked ? '_blank' : '_self';
                    
                    linkElement.href = url;
                    linkElement.textContent = text;
                    linkElement.target = target;
                    
                    this.saveHistory();
                    this.closeModal();
                    this.showToast('Lien modifié!', 'success');
                });
            }
            
            uploadImage(placeholder) {
                this.selectedElement = placeholder;
                document.getElementById('image-upload').click();
            }
            
            handleImageUpload(input) {
                const file = input.files[0];
                if (!file) return;
                
                const reader = new FileReader();
                reader.onload = (e) => {
                    if (this.selectedElement) {
                        this.replaceWithImage(this.selectedElement, e.target.result);
                    }
                };
                reader.readAsDataURL(file);
            }
            
            replaceWithImage(placeholder, src) {
                const img = document.createElement('img');
                img.src = src;
                img.className = 'image-preview';
                img.alt = 'Image uploadée';
                img.style.width = '100%';
                img.style.height = '100%';
                img.style.objectFit = 'cover';
                
                placeholder.innerHTML = '';
                placeholder.appendChild(img);
                placeholder.classList.remove('image-placeholder');
                
                this.saveHistory();
                this.showToast('Image ajoutée!', 'success');
            }
            
            uploadVideo(placeholder) {
                this.showModal('Ajouter une vidéo', `
                    <div class="property-group">
                        <label class="property-label">URL de la vidéo (YouTube, Vimeo, ou lien direct)</label>
                        <input type="text" class="property-input" id="video-url" placeholder="https://...">
                    </div>
                    <div class="property-group">
                        <label class="property-label">Ou uploader un fichier</label>
                        <input type="file" class="property-input" accept="video/*" id="video-file">
                    </div>
                `, () => {
                    const url = document.getElementById('video-url').value;
                    const file = document.getElementById('video-file').files[0];
                    
                    if (url) {
                        // Gérer YouTube/Vimeo
                        let embedUrl = url;
                        if (url.includes('youtube.com') || url.includes('youtu.be')) {
                            const videoId = this.extractYouTubeId(url);
                            embedUrl = `https://www.youtube.com/embed/${videoId}`;
                        } else if (url.includes('vimeo.com')) {
                            const videoId = url.split('/').pop();
                            embedUrl = `https://player.vimeo.com/video/${videoId}`;
                        }
                        
                        placeholder.innerHTML = `
                            <iframe src="${embedUrl}" width="100%" height="100%" frameborder="0" allowfullscreen></iframe>
                        `;
                    } else if (file) {
                        const reader = new FileReader();
                        reader.onload = (e) => {
                            placeholder.innerHTML = `
                                <video width="100%" height="100%" controls>
                                    <source src="${e.target.result}" type="${file.type}">
                                </video>
                            `;
                        };
                        reader.readAsDataURL(file);
                    }
                    
                    placeholder.classList.remove('image-placeholder');
                    this.saveHistory();
                    this.closeModal();
                    this.showToast('Vidéo ajoutée!', 'success');
                });
            }
            
            extractYouTubeId(url) {
                const match = url.match(/(?:youtube\.com\/watch\?v=|youtu\.be\/)([^&\n?#]+)/);
                return match ? match[1] : '';
            }
            
            // Propriétés des éléments
            showElementProperties(element) {
                const tagName = element.tagName.toLowerCase();
                const styles = window.getComputedStyle(element);
                
                let content = '';
                
                // Propriétés de texte
                if (this.isTextElement(element)) {
                    content += `
                        <div class="properties-section">
                            <h3 class="properties-section-title">
                                <svg class="icon icon-sm" viewBox="0 0 24 24">
                                    <path d="M3 17.25V21h3.75L17.81 9.94l-3.75-3.75L3 17.25zM20.71 7.04c.39-.39.39-1.02 0-1.41l-2.34-2.34c-.39-.39-1.02-.39-1.41 0l-1.83 1.83 3.75 3.75 1.83-1.83z"/>
                                </svg>
                                Typographie
                            </h3>
                            
                            <div class="property-group">
                                <label class="property-label">Police</label>
                                <select class="property-select" onchange="comfyCMS.updateStyle('fontFamily', this.value)">
                                    <option value="'Playfair Display', serif" ${styles.fontFamily.includes('Playfair') ? 'selected' : ''}>Playfair Display</option>
                                    <option value="'Inter', sans-serif" ${styles.fontFamily.includes('Inter') ? 'selected' : ''}>Inter</option>
                                    <option value="'Roboto', sans-serif">Roboto</option>
                                    <option value="'Open Sans', sans-serif">Open Sans</option>
                                    <option value="'Montserrat', sans-serif">Montserrat</option>
                                    <option value="'Lato', sans-serif">Lato</option>
                                    <option value="'Poppins', sans-serif">Poppins</option>
                                    <option value="'Raleway', sans-serif">Raleway</option>
                                    <option value="Georgia, serif">Georgia</option>
                                    <option value="'Times New Roman', serif">Times New Roman</option>
                                </select>
                            </div>
                            
                            <div class="property-group">
                                <label class="property-label">Taille ${tagName}</label>
                                <div style="display: flex; gap: var(--space-2); align-items: center;">
                                    <input type="range" class="range-input" min="10" max="120" value="${parseInt(styles.fontSize)}" 
                                           oninput="comfyCMS.updateStyle('fontSize', this.value + 'px'); document.getElementById('font-size-value').textContent = this.value + 'px'">
                                    <span class="range-value" id="font-size-value">${parseInt(styles.fontSize)}px</span>
                                </div>
                            </div>
                            
                            <div class="property-group">
                                <label class="property-label">Épaisseur</label>
                                <select class="property-select" onchange="comfyCMS.updateStyle('fontWeight', this.value)">
                                    <option value="300">Light (300)</option>
                                    <option value="400" ${styles.fontWeight == '400' ? 'selected' : ''}>Regular (400)</option>
                                    <option value="500">Medium (500)</option>
                                    <option value="600">Semi-Bold (600)</option>
                                    <option value="700">Bold (700)</option>
                                    <option value="800">Extra-Bold (800)</option>
                                    <option value="900">Black (900)</option>
                                </select>
                            </div>
                            
                            <div class="property-group">
                                <label class="property-label">Alignement</label>
                                <div style="display: flex; gap: var(--space-1);">
                                    <button class="toolbar-btn ${styles.textAlign === 'left' ? 'active' : ''}" onclick="comfyCMS.updateStyle('textAlign', 'left')">
                                        <svg class="icon icon-sm" viewBox="0 0 24 24">
                                            <path d="M3 21h18v-2H3v2zm0-4h10v-2H3v2zm0-4h18v-2H3v2zm0-4h10V7H3v2zm0-6v2h18V3H3z"/>
                                        </svg>
                                    </button>
                                    <button class="toolbar-btn ${styles.textAlign === 'center' ? 'active' : ''}" onclick="comfyCMS.updateStyle('textAlign', 'center')">
                                        <svg class="icon icon-sm" viewBox="0 0 24 24">
                                            <path d="M7 15v2h10v-2H7zm-4 6h18v-2H3v2zm0-8h18v-2H3v2zm4-6v2h10V7H7zM3 3v2h18V3H3z"/>
                                        </svg>
                                    </button>
                                    <button class="toolbar-btn ${styles.textAlign === 'right' ? 'active' : ''}" onclick="comfyCMS.updateStyle('textAlign', 'right')">
                                        <svg class="icon icon-sm" viewBox="0 0 24 24">
                                            <path d="M3 21h18v-2H3v2zm6-4h12v-2H9v2zm-6-4h18v-2H3v2zm6-4h12V7H9v2zM3 3v2h18V3H3z"/>
                                        </svg>
                                    </button>
                                    <button class="toolbar-btn ${styles.textAlign === 'justify' ? 'active' : ''}" onclick="comfyCMS.updateStyle('textAlign', 'justify')">
                                        <svg class="icon icon-sm" viewBox="0 0 24 24">
                                            <path d="M3 21h18v-2H3v2zm0-4h18v-2H3v2zm0-4h18v-2H3v2zm0-4h18V7H3v2zm0-6v2h18V3H3z"/>
                                        </svg>
                                    </button>
                                </div>
                            </div>
                            
                            <div class="property-group">
                                <label class="property-label">Appliquer à tous les ${tagName}</label>
                                <button class="btn btn-secondary" style="width: 100%;" onclick="comfyCMS.applyToAllSimilar('${tagName}')">
                                    Appliquer à tous
                                </button>
                            </div>
                        </div>
                    `;
                }
                
                // Couleurs
                content += `
                    <div class="properties-section">
                        <h3 class="properties-section-title">
                            <svg class="icon icon-sm" viewBox="0 0 24 24">
                                <path d="M12 3c-4.97 0-9 4.03-9 9s4.03 9 9 9c.83 0 1.5-.67 1.5-1.5 0-.39-.15-.74-.39-1.01-.23-.26-.38-.61-.38-.99 0-.83.67-1.5 1.5-1.5H16c2.76 0 5-2.24 5-5 0-4.42-4.03-8-9-8zm-5.5 9c-.83 0-1.5-.67-1.5-1.5S5.67 9 6.5 9 8 9.67 8 10.5 7.33 12 6.5 12zm3-4C8.67 8 8 7.33 8 6.5S8.67 5 9.5 5s1.5.67 1.5 1.5S10.33 8 9.5 8zm5 0c-.83 0-1.5-.67-1.5-1.5S13.67 5 14.5 5s1.5.67 1.5 1.5S15.33 8 14.5 8zm3 4c-.83 0-1.5-.67-1.5-1.5S16.67 9 17.5 9s1.5.67 1.5 1.5-.67 1.5-1.5 1.5z"/>
                            </svg>
                            Couleurs
                        </h3>
                        
                        <div class="property-group">
                            <label class="property-label">Couleur du texte</label>
                            <div class="color-picker-grid">
                                ${this.generateColorSwatches('color')}
                            </div>
                            <input type="color" class="property-input" value="${this.rgbToHex(styles.color)}" 
                                   onchange="comfyCMS.updateStyle('color', this.value)">
                        </div>
                        
                        <div class="property-group">
                            <label class="property-label">Arrière-plan</label>
                            <div class="color-picker-grid">
                                ${this.generateColorSwatches('backgroundColor')}
                            </div>
                            <input type="color" class="property-input" value="${this.rgbToHex(styles.backgroundColor)}" 
                                   onchange="comfyCMS.updateStyle('backgroundColor', this.value)">
                        </div>
                    </div>
                `;
                
                // Espacement et marges
                content += `
                    <div class="properties-section">
                        <h3 class="properties-section-title">
                            <svg class="icon icon-sm" viewBox="0 0 24 24">
                                <path d="M3 3h18v2H3zm0 16h18v2H3zm0-8h18v2H3zm0 4h18v2H3zm0-8h18v2H3z"/>
                            </svg>
                            Espacement
                        </h3>
                        
                        <div class="property-group">
                            <label class="property-label">Marges (${this.currentDevice})</label>
                            <div class="margin-controls">
                                <div class="margin-input-group">
                                    <span class="margin-label">Haut</span>
                                    <input type="number" class="margin-input" value="${parseInt(styles.marginTop)}" 
                                           onchange="comfyCMS.updateMargin('marginTop', this.value + 'px')">
                                </div>
                                <div class="margin-input-group">
                                    <span class="margin-label">Droite</span>
                                    <input type="number" class="margin-input" value="${parseInt(styles.marginRight)}" 
                                           onchange="comfyCMS.updateMargin('marginRight', this.value + 'px')">
                                </div>
                                <div class="margin-input-group">
                                    <span class="margin-label">Bas</span>
                                    <input type="number" class="margin-input" value="${parseInt(styles.marginBottom)}" 
                                           onchange="comfyCMS.updateMargin('marginBottom', this.value + 'px')">
                                </div>
                                <div class="margin-input-group">
                                    <span class="margin-label">Gauche</span>
                                    <input type="number" class="margin-input" value="${parseInt(styles.marginLeft)}" 
                                           onchange="comfyCMS.updateMargin('marginLeft', this.value + 'px')">
                                </div>
                            </div>
                        </div>
                        
                        <div class="property-group">
                            <label class="property-label">Padding (${this.currentDevice})</label>
                            <div class="margin-controls">
                                <div class="margin-input-group">
                                    <span class="margin-label">Haut</span>
                                    <input type="number" class="margin-input" value="${parseInt(styles.paddingTop)}" 
                                           onchange="comfyCMS.updateMargin('paddingTop', this.value + 'px')">
                                </div>
                                <div class="margin-input-group">
                                    <span class="margin-label">Droite</span>
                                    <input type="number" class="margin-input" value="${parseInt(styles.paddingRight)}" 
                                           onchange="comfyCMS.updateMargin('paddingRight', this.value + 'px')">
                                </div>
                                <div class="margin-input-group">
                                    <span class="margin-label">Bas</span>
                                    <input type="number" class="margin-input" value="${parseInt(styles.paddingBottom)}" 
                                           onchange="comfyCMS.updateMargin('paddingBottom', this.value + 'px')">
                                </div>
                                <div class="margin-input-group">
                                    <span class="margin-label">Gauche</span>
                                    <input type="number" class="margin-input" value="${parseInt(styles.paddingLeft)}" 
                                           onchange="comfyCMS.updateMargin('paddingLeft', this.value + 'px')">
                                </div>
                            </div>
                        </div>
                    </div>
                `;
                
                // Palettes de couleurs
                content += `
                    <div class="properties-section">
                        <h3 class="properties-section-title">
                            <svg class="icon icon-sm" viewBox="0 0 24 24">
                                <path d="M12 2C6.49 2 2 6.49 2 12s4.49 10 10 10c1.38 0 2.5-1.12 2.5-2.5 0-.61-.23-1.2-.64-1.67-.08-.09-.13-.21-.13-.33 0-.28.22-.5.5-.5H16c3.31 0 6-2.69 6-6 0-4.96-4.49-9-10-9zm-5.5 10c-.83 0-1.5-.67-1.5-1.5S5.67 9 6.5 9 8 9.67 8 10.5 7.33 12 6.5 12zm3-4C8.67 8 8 7.33 8 6.5S8.67 5 9.5 5s1.5.67 1.5 1.5S10.33 8 9.5 8zm5 0c-.83 0-1.5-.67-1.5-1.5S13.67 5 14.5 5s1.5.67 1.5 1.5S15.33 8 14.5 8zm4.5 2.5c0 .83-.67 1.5-1.5 1.5s-1.5-.67-1.5-1.5S16.67 9 17.5 9s1.5.67 1.5 1.5z"/>
                            </svg>
                            Palettes de couleurs
                        </h3>
                        
                        <div class="palette-grid">
                            ${this.colorPalettes.map((palette, index) => `
                                <div class="palette-item" onclick="comfyCMS.applyColorPalette(${index})">
                                    <div class="palette-colors">
                                        <div class="palette-color" style="background: ${palette.primary}"></div>
                                        <div class="palette-color" style="background: ${palette.secondary}"></div>
                                        <div class="palette-color" style="background: ${palette.accent}"></div>
                                        <div class="palette-color" style="background: ${palette.neutral}"></div>
                                    </div>
                                    <p class="palette-name">${palette.name}</p>
                                </div>
                            `).join('')}
                        </div>
                    </div>
                `;
                
                document.getElementById('properties-content').innerHTML = content;
            }
            
            generateColorSwatches(property) {
                const colors = [
                    '#000000', '#1a1f2c', '#3F3F46', '#71717A', '#8e9196', '#A1A1AA', '#E4E4E7',
                    '#FFFFFF', '#f7f5ff', '#e5deff', '#9b87f5', '#7e69ab', '#6366F1', '#4F46E5',
                    '#ff8e6e', '#ffd5cc', '#ffc85c', '#fff1d7', '#EF4444', '#F97316', '#F59E0B',
                    '#EAB308', '#84CC16', '#22C55E', '#10B981', '#14B8A6', '#06B6D4', '#0EA5E9'
                ];
                
                return colors.map(color => `
                    <div class="color-swatch" style="background: ${color}" 
                         onclick="comfyCMS.updateStyle('${property}', '${color}')"
                         title="${color}"></div>
                `).join('');
            }
            
            updateStyle(property, value) {
                if (!this.selectedElement) return;
                
                this.selectedElement.style[property] = value;
                this.saveHistory();
            }
            
            updateMargin(property, value) {
                if (!this.selectedElement) return;
                
                // Sauvegarder la valeur pour le device actuel
                this.marginManager.setMargin(this.selectedElement, property, value, this.currentDevice);
                
                // Appliquer immédiatement
                this.selectedElement.style[property] = value;
                this.saveHistory();
            }
            
            applyToAllSimilar(tagName) {
                const elements = document.querySelectorAll(`#preview-content ${tagName}.editable`);
                const sourceStyles = window.getComputedStyle(this.selectedElement);
                
                elements.forEach(el => {
                    el.style.fontFamily = sourceStyles.fontFamily;
                    el.style.fontSize = sourceStyles.fontSize;
                    el.style.fontWeight = sourceStyles.fontWeight;
                    el.style.color = sourceStyles.color;
                    el.style.textAlign = sourceStyles.textAlign;
                    el.style.lineHeight = sourceStyles.lineHeight;
                });
                
                this.saveHistory();
                this.showToast(`Styles appliqués à tous les ${tagName}`, 'success');
            }
            
            applyColorPalette(paletteIndex) {
                const palette = this.colorPalettes[paletteIndex];
                if (!palette) return;
                
                // Mettre à jour les variables CSS SEULEMENT pour le contenu du site
                const styleTag = document.getElementById('template-styles');
                if (styleTag) {
                    // Remplacer les variables CSS dans le style du template
                    let css = styleTag.textContent;
                    
                    // Mettre à jour les variables
                    const colorVars = `
                        :root {
                            --color-primary: ${palette.primary};
                            --color-primary-dark: ${this.darkenColor(palette.primary, 20)};
                            --color-secondary: ${palette.secondary};
                            --color-accent: ${palette.accent};
                            --color-neutral: ${palette.neutral};
                            --color-background: ${palette.background};
                            --color-background-alt: ${this.lightenColor(palette.background, 5)};
                        }
                    `;
                    
                    // Remplacer ou ajouter les variables
                    if (css.includes(':root')) {
                        css = css.replace(/:root\s*{[^}]*}/, colorVars);
                    } else {
                        css = colorVars + '\n' + css;
                    }
                    
                    styleTag.textContent = css;
                }
                
                this.saveHistory();
                this.showToast(`Palette "${palette.name}" appliquée!`, 'success');
            }
            
            darkenColor(color, percent) {
                // Simple fonction pour assombrir une couleur
                const num = parseInt(color.replace('#', ''), 16);
                const amt = Math.round(2.55 * percent);
                const R = (num >> 16) - amt;
                const G = (num >> 8 & 0x00FF) - amt;
                const B = (num & 0x0000FF) - amt;
                return '#' + (0x1000000 + (R < 255 ? R < 1 ? 0 : R : 255) * 0x10000 +
                    (G < 255 ? G < 1 ? 0 : G : 255) * 0x100 +
                    (B < 255 ? B < 1 ? 0 : B : 255)).toString(16).slice(1);
            }
            
            lightenColor(color, percent) {
                // Simple fonction pour éclaircir une couleur
                const num = parseInt(color.replace('#', ''), 16);
                const amt = Math.round(2.55 * percent);
                const R = (num >> 16) + amt;
                const G = (num >> 8 & 0x00FF) + amt;
                const B = (num & 0x0000FF) + amt;
                return '#' + (0x1000000 + (R < 255 ? R < 1 ? 0 : R : 255) * 0x10000 +
                    (G < 255 ? G < 1 ? 0 : G : 255) * 0x100 +
                    (B < 255 ? B < 1 ? 0 : B : 255)).toString(16).slice(1);
            }
            
            // Floating toolbar
            positionFloatingToolbar(element) {
                const toolbar = document.getElementById('floating-toolbar');
                const rect = element.getBoundingClientRect();
                
                // Positionner au-dessus de l'élément
                toolbar.style.top = (rect.top - 50) + 'px';
                toolbar.style.left = rect.left + 'px';
                toolbar.classList.add('active');
            }
            
            textCommand(command) {
                document.execCommand(command, false, null);
                this.saveHistory();
            }
            
            insertLink() {
                const url = prompt('Entrez l\'URL :');
                if (url) {
                    document.execCommand('createLink', false, url);
                    this.saveHistory();
                }
            }
            
            changeTextColor() {
                this.showModal('Choisir une couleur', `
                    <div class="color-picker-grid">
                        ${this.generateColorSwatches('foreColor')}
                    </div>
                    <div class="property-group">
                        <label class="property-label">Couleur personnalisée</label>
                        <input type="color" class="property-input" id="custom-color" value="#000000">
                    </div>
                `, () => {
                    const color = document.getElementById('custom-color').value;
                    document.execCommand('foreColor', false, color);
                    this.saveHistory();
                    this.closeModal();
                });
            }
            
            // Gestion des onglets
            switchTab(tab) {
                this.currentTab = tab;
                
                // Mettre à jour les onglets actifs
                document.querySelectorAll('.sidebar-tab').forEach(t => t.classList.remove('active'));
                event.target.classList.add('active');
                
                // Réinitialiser la recherche
                const searchInput = document.getElementById('search-input');
                if (searchInput) searchInput.value = '';
                
                // Charger le contenu
                switch(tab) {
                    case 'templates':
                        this.loadTemplatesTab();
                        break;
                    case 'sections':
                        this.loadSectionsTab();
                        break;
                    case 'clients':
                        this.loadClientsTab();
                        break;
                    case 'assets':
                        this.loadAssetsTab();
                        break;
                }
            }
            
            search(term) {
                // Rechercher dans l'onglet actuel
                switch(this.currentTab) {
                    case 'templates':
                        this.loadTemplatesTab();
                        break;
                    case 'sections':
                        this.loadSectionsTab();
                        break;
                    case 'clients':
                        this.loadClientsTab();
                        break;
                }
            }
            
            // Gestion des appareils et zoom
            setDevice(device) {
                this.currentDevice = device;
                
                // Mettre à jour les boutons
                document.querySelectorAll('.device-btn').forEach(btn => btn.classList.remove('active'));
                event.target.classList.add('active');
                
                // Mettre à jour la frame
                const frame = document.getElementById('preview-frame');
                frame.className = 'preview-frame ' + device;
                
                // Appliquer les marges spécifiques au device
                this.marginManager.applyDeviceMargins(device);
            }
            
            zoom(direction) {
                if (direction === 'in' && this.zoomLevel < 200) {
                    this.zoomLevel += 10;
                } else if (direction === 'out' && this.zoomLevel > 50) {
                    this.zoomLevel -= 10;
                }
                
                const frame = document.getElementById('preview-frame');
                frame.style.transform = `translateX(-50%) scale(${this.zoomLevel / 100})`;
                
                document.getElementById('zoom-level').textContent = this.zoomLevel + '%';
            }
            
            // Gestion des projets
            newProject() {
                if (confirm('Créer un nouveau projet ? Les modifications non sauvegardées seront perdues.')) {
                    this.createNewProject();
                }
            }
            
            createNewProject() {
                this.currentProject = {
                    id: this.generateId(),
                    name: 'Nouveau Projet',
                    created: Date.now(),
                    modified: Date.now(),
                    template: null,
                    content: '',
                    styles: '',
                    settings: {
                        seoTitle: 'Titre de la page',
                        seoDescription: 'Description de la page'
                    }
                };

                document.getElementById('project-name-display').textContent = this.currentProject.name;
                
                document.getElementById('preview-content').innerHTML = `
                    <div style="text-align: center; padding: 5rem 2rem;">
                        <svg class="icon" style="width: 64px; height: 64px; color: var(--primary); margin-bottom: 1rem;" viewBox="0 0 24 24">
                            <rect x="3" y="3" width="18" height="18" rx="2" ry="2"/>
                            <line x1="9" y1="9" x2="15" y2="9"/>
                            <line x1="9" y1="15" x2="15" y2="15"/>
                        </svg>
                        <h2 style="color: var(--primary); margin-bottom: 0.5rem; font-family: var(--font-primary);">Choisissez un template pour commencer</h2>
                        <p style="color: var(--gray);">Sélectionnez un template dans la barre latérale ou créez à partir de zéro</p>
                    </div>
                `;
                
                this.loadTemplatesTab();
                this.history = [];
                this.historyIndex = -1;
                this.saveHistory();
            }
            
            openProject() {
                const projects = JSON.parse(localStorage.getItem('comfycms_projects') || '[]');
                if (projects.length === 0) {
                    this.showToast('Aucun projet sauvegardé trouvé.', 'info');
                    return;
                }

                const projectsListHtml = projects.map(p => `
                    <div class="client-item" style="display: flex; justify-content: space-between; align-items: center; gap: 1rem;">
                        <div>
                            <h4 class="client-name">${p.name}</h4>
                            <p class="client-info">Dernière modification: ${new Date(p.modified).toLocaleString()}</p>
                        </div>
                        <button class="btn btn-secondary" onclick="comfyCMS.loadProject('${p.id}')">Charger</button>
                    </div>
                `).join('');

                this.showModal('Ouvrir un Projet', `
                    <div class="client-list">
                        ${projectsListHtml}
                    </div>
                `, null, false);
            }
            
            loadProject(projectId) {
                if (!confirm('Charger ce projet ? Les modifications actuelles non sauvegardées seront perdues.')) return;

                const projects = JSON.parse(localStorage.getItem('comfycms_projects') || '[]');
                const projectToLoad = projects.find(p => p.id === projectId);

                if (projectToLoad) {
                    this.currentProject = projectToLoad;
                    
                    document.getElementById('preview-content').innerHTML = this.currentProject.content;
                    
                    const styleTag = document.getElementById('template-styles') || document.createElement('style');
                    styleTag.id = 'template-styles';
                    styleTag.textContent = this.currentProject.styles;
                    document.head.appendChild(styleTag);
                    
                    document.getElementById('project-name-display').textContent = this.currentProject.name;

                    this.makeEverythingEditable();
                    this.addSectionControls();

                    this.history = [];
                    this.historyIndex = -1;
                    this.saveHistory();
                    
                    this.closeModal();
                    this.showToast(`Projet "${this.currentProject.name}" chargé!`, 'success');
                } else {
                    this.showToast('Erreur: Projet non trouvé.', 'error');
                }
            }
            
            saveProject() {
                if (!this.currentProject) return;
                
                // Sauvegarder le contenu
                this.currentProject.content = document.getElementById('preview-content').innerHTML;
                this.currentProject.styles = document.getElementById('template-styles')?.textContent || '';
                this.currentProject.modified = Date.now();
                
                // Sauvegarder dans localStorage
                const projects = JSON.parse(localStorage.getItem('comfycms_projects') || '[]');
                const index = projects.findIndex(p => p.id === this.currentProject.id);
                
                if (index >= 0) {
                    projects[index] = this.currentProject;
                } else {
                    projects.push(this.currentProject);
                }
                
                localStorage.setItem('comfycms_projects', JSON.stringify(projects));
                
                this.showToast('Projet sauvegardé!', 'success');
            }

            renameProject() {
                const newName = prompt('Entrez le nouveau nom du projet:', this.currentProject.name);
                if (newName && newName.trim() !== '') {
                    this.currentProject.name = newName.trim();
                    document.getElementById('project-name-display').textContent = this.currentProject.name;
                    this.saveProject();
                    this.showToast('Projet renommé.', 'success');
                }
            }
            
            // Export
            exportProject() {
                if (!this.currentProject) {
                    this.showToast('Veuillez d\'abord sauvegarder le projet.', 'error');
                    return;
                }
                
                this.showModal('Exporter le projet', `
                    <div class="property-group">
                        <label class="property-label">Format d'export</label>
                        <select class="property-select" id="export-format">
                            <option value="html">HTML Statique</option>
                            <option value="zip">ZIP Complet (Indisponible)</option>
                        </select>
                    </div>
                    
                    <div class="property-group">
                        <label class="property-label">Options</label>
                        <label style="display: block; margin-bottom: 0.5rem;">
                            <input type="checkbox" id="export-minify" checked> Minifier le code
                        </label>
                    </div>
                    
                    <div class="property-group">
                        <label class="property-label">Nom du fichier</label>
                        <input type="text" class="property-input" id="export-name" value="${this.currentProject.name.replace(/\s/g, '_')}">
                    </div>
                `, () => {
                    this.performExport();
                });
            }
            
            performExport() {
                const format = document.getElementById('export-format').value;
                const minify = document.getElementById('export-minify').checked;
                const projectName = document.getElementById('export-name').value;
                const seoTitle = this.currentProject.settings.seoTitle || this.currentProject.name;
                const seoDescription = this.currentProject.settings.seoDescription || 'Site créé avec ComfyCMS';
                
                // Récupérer le contenu
                let content = document.getElementById('preview-content').innerHTML;
                let styles = document.getElementById('template-styles')?.textContent || '';
                
                // Nettoyer le HTML
                content = this.cleanExportHTML(content);
                
                // Minifier si demandé
                if (minify) {
                    content = content.replace(/\s+/g, ' ').trim();
                    styles = styles.replace(/\s+/g, ' ').trim();
                }
                
                // Créer le HTML complet
                const html = `<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta name="description" content="${seoDescription}">
    <title>${seoTitle}</title>
    
    <!-- Google Fonts -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Playfair+Display:wght@400;500;600;700;800;900&family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    
    <style>
        /* Reset CSS */
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        body {
            font-family: 'Inter', -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif;
            line-height: 1.6;
            color: #333;
        }
        
        h1, h2, h3, h4, h5, h6 {
            font-family: 'Playfair Display', serif;
        }
        
        /* Styles du template */
        ${styles}
    </style>
</head>
<body>
    ${content}
</body>
</html>`;
                
                // Télécharger selon le format
                if (format === 'html') {
                    this.downloadFile(html, projectName + '.html', 'text/html');
                }
                
                this.closeModal();
                this.showToast('Export réussi!', 'success');
            }
            
            cleanExportHTML(html) {
                // Nettoyer le HTML pour l'export
                const temp = document.createElement('div');
                temp.innerHTML = html;
                
                // Supprimer les classes d'édition
                temp.querySelectorAll('.editable, .editing, .editable-link').forEach(el => {
                    el.classList.remove('editable', 'editing', 'editable-link');
                    el.removeAttribute('contenteditable');
                });
                
                // Supprimer les contrôles de section
                temp.querySelectorAll('.section-controls, .section-handle').forEach(el => el.remove());
                
                // Supprimer les classes de section
                temp.querySelectorAll('.section-container').forEach(el => {
                    el.classList.remove('section-container', 'selected');
                });
                
                // Nettoyer les placeholders d'images
                temp.querySelectorAll('.image-placeholder').forEach(el => {
                    if (!el.querySelector('img')) {
                        el.innerHTML = '';
                    }
                });
                
                return temp.innerHTML;
            }
            
            downloadFile(content, filename, type) {
                const blob = new Blob([content], { type });
                const url = URL.createObjectURL(blob);
                const a = document.createElement('a');
                a.href = url;
                a.download = filename;
                document.body.appendChild(a);
                a.click();
                document.body.removeChild(a);
                URL.revokeObjectURL(url);
            }
            
            // Preview
            preview() {
                const content = document.getElementById('preview-content').innerHTML;
                const styles = document.getElementById('template-styles')?.textContent || '';
                const cleanContent = this.cleanExportHTML(content);
                const seoTitle = this.currentProject.settings.seoTitle || this.currentProject.name;
                
                const previewWindow = window.open('', '_blank');
                previewWindow.document.write(`
                    <!DOCTYPE html>
                    <html>
                    <head>
                        <meta charset="UTF-8">
                        <meta name="viewport" content="width=device-width, initial-scale=1.0">
                        <title>Preview - ${seoTitle}</title>
                        <link href="https://fonts.googleapis.com/css2?family=Playfair+Display:wght@400;500;600;700;800;900&family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">
                        <style>
                            * { margin: 0; padding: 0; box-sizing: border-box; }
                            body { font-family: 'Inter', sans-serif; }
                            h1, h2, h3, h4, h5, h6 { font-family: 'Playfair Display', serif; }
                            ${styles}
                        </style>
                    </head>
                    <body>${cleanContent}</body>
                    </html>
                `);
            }

            showSeoSettings() {
                if (!this.currentProject) return;

                const settings = this.currentProject.settings;

                this.showModal('Paramètres SEO', `
                    <div class="property-group">
                        <label class="property-label">Titre de la page (balise &lt;title&gt;)</label>
                        <input type="text" class="property-input" id="seo-title-input" value="${settings.seoTitle || ''}">
                    </div>
                    <div class="property-group">
                        <label class="property-label">Méta-description</label>
                        <textarea class="property-input" id="seo-description-input" rows="4">${settings.seoDescription || ''}</textarea>
                    </div>
                `, () => {
                    this.saveSeoSettings();
                });
            }

            saveSeoSettings() {
                const newTitle = document.getElementById('seo-title-input').value;
                const newDescription = document.getElementById('seo-description-input').value;

                this.currentProject.settings.seoTitle = newTitle;
                this.currentProject.settings.seoDescription = newDescription;

                this.saveProject();
                this.closeModal();
                this.showToast('Paramètres SEO sauvegardés!', 'success');
            }
            
            // Histoire
            saveHistory() {
                const state = {
                    content: document.getElementById('preview-content').innerHTML,
                    styles: document.getElementById('template-styles')?.textContent || '',
                    projectName: this.currentProject.name,
                    projectSettings: JSON.parse(JSON.stringify(this.currentProject.settings))
                };
                
                // Supprimer les états futurs
                this.history = this.history.slice(0, this.historyIndex + 1);
                
                // Ajouter le nouvel état
                this.history.push(state);
                this.historyIndex++;
                
                // Limiter l'historique
                if (this.history.length > 50) {
                    this.history.shift();
                    this.historyIndex--;
                }
            }
            
            undo() {
                if (this.historyIndex > 0) {
                    this.historyIndex--;
                    this.restoreState(this.history[this.historyIndex]);
                    this.showToast('Annulé', 'info');
                }
            }
            
            redo() {
                if (this.historyIndex < this.history.length - 1) {
                    this.historyIndex++;
                    this.restoreState(this.history[this.historyIndex]);
                    this.showToast('Refait', 'info');
                }
            }
            
            restoreState(state) {
                document.getElementById('preview-content').innerHTML = state.content;
                
                const styleTag = document.getElementById('template-styles');
                if (styleTag) {
                    styleTag.textContent = state.styles;
                }
                
                this.currentProject.name = state.projectName;
                this.currentProject.settings = state.projectSettings;
                document.getElementById('project-name-display').textContent = state.projectName;

                this.makeEverythingEditable();
                this.addSectionControls();
            }
            
            // Rendre tout éditable
            makeEverythingEditable() {
                // Textes éditables
                document.querySelectorAll('#preview-content h1, #preview-content h2, #preview-content h3, #preview-content h4, #preview-content h5, #preview-content h6, #preview-content p, #preview-content span, #preview-content li').forEach(el => {
                    if (!el.classList.contains('editable') && !el.closest('.section-controls')) {
                        el.classList.add('editable');
                    }
                });
                
                // Liens éditables
                document.querySelectorAll('#preview-content a').forEach(el => {
                    if (!el.classList.contains('editable-link')) {
                        el.classList.add('editable-link');
                    }
                });
                
                // Images cliquables
                document.querySelectorAll('#preview-content .image-placeholder, #preview-content img').forEach(el => {
                    el.style.cursor = 'pointer';
                });
            }
            
            // UI Helpers
            showModal(title, content, onConfirm, showFooter = true) {
                document.getElementById('modal-title').textContent = title;
                document.getElementById('modal-body').innerHTML = content;
                
                const footer = document.getElementById('modal-footer');
                if (showFooter) {
                    footer.style.display = 'flex';
                    const confirmBtn = document.getElementById('modal-confirm');
                    confirmBtn.onclick = onConfirm || (() => this.closeModal());
                } else {
                    footer.style.display = 'none';
                }
                
                document.getElementById('modal-backdrop').classList.add('active');
            }
            
            closeModal(event) {
                if (event && event.target !== event.currentTarget) return;
                document.getElementById('modal-backdrop').classList.remove('active');
            }
            
            showToast(message, type = 'info') {
                const toast = document.createElement('div');
                toast.className = `toast ${type}`;
                
                const icon = {
                    success: '<path d="M9 11l3 3L22 4" stroke="currentColor" stroke-width="2" fill="none"/>',
                    error: '<path d="M6 18L18 6M6 6l12 12" stroke="currentColor" stroke-width="2"/>',
                    info: '<circle cx="12" cy="12" r="10" stroke="currentColor" stroke-width="2" fill="none"/><path d="M12 16v-4m0-4h.01" stroke="currentColor" stroke-width="2"/>'
                };
                
                toast.innerHTML = `
                    <svg class="toast-icon" viewBox="0 0 24 24">
                        ${icon[type] || icon.info}
                    </svg>
                    <span class="toast-message">${message}</span>
                `;
                
                document.getElementById('toast-container').appendChild(toast);
                
                setTimeout(() => {
                    toast.style.opacity = '0';
                    toast.style.transform = 'translateX(100%)';
                    setTimeout(() => toast.remove(), 300);
                }, 3000);
            }
            
            // Utilitaires
            generateId() {
                return Date.now().toString(36) + Math.random().toString(36).substr(2);
            }
            
            rgbToHex(rgb) {
                if (!rgb || rgb.startsWith('#')) return rgb || '#000000';
                
                const match = rgb.match(/^rgba?\((\d+),\s*(\d+),\s*(\d+)/);
                if (!match) return '#000000';
                
                const hex = (x) => {
                    const h = parseInt(x).toString(16);
                    return h.length === 1 ? '0' + h : h;
                };
                
                return '#' + hex(match[1]) + hex(match[2]) + hex(match[3]);
            }
        }
        
        // Gestionnaire de clients
        class ClientManager {
            constructor() {
                this.clients = JSON.parse(localStorage.getItem('comfycms_clients') || '[]');
            }
            
            getClients() {
                return this.clients;
            }
            
            getClient(id) {
                return this.clients.find(c => c.id === id);
            }
            
            addClient(data) {
                const client = {
                    id: Date.now().toString(),
                    ...data,
                    created: Date.now(),
                    modified: Date.now()
                };
                
                this.clients.push(client);
                this.save();
                return client;
            }
            
            updateClient(id, data) {
                const index = this.clients.findIndex(c => c.id === id);
                if (index >= 0) {
                    this.clients[index] = {
                        ...this.clients[index],
                        ...data,
                        modified: Date.now()
                    };
                    this.save();
                }
            }
            
            deleteClient(id) {
                this.clients = this.clients.filter(c => c.id !== id);
                this.save();
            }
            
            save() {
                localStorage.setItem('comfycms_clients', JSON.stringify(this.clients));
            }
        }
        
        // Gestionnaire de sections
        class SectionManager {
            constructor() {
                this.sections = new Map();
            }
            
            registerSection(section) {
                this.sections.set(section.id, section);
            }
            
            getSection(id) {
                return this.sections.get(id);
            }
            
            getAllSections() {
                return Array.from(this.sections.values());
            }
        }
        
        // Gestionnaire de couleurs
        class ColorManager {
            constructor() {
                this.currentPalette = null;
            }
            
            applyPalette(palette) {
                this.currentPalette = palette;
                // Application des couleurs gérée par la classe principale
            }
        }
        
        // Gestionnaire de marges responsive
        class MarginManager {
            constructor() {
                this.margins = new Map();
            }
            
            setMargin(element, property, value, device) {
                const id = element.dataset.marginId || this.generateId();
                element.dataset.marginId = id;
                
                if (!this.margins.has(id)) {
                    this.margins.set(id, {});
                }
                
                const margins = this.margins.get(id);
                if (!margins[device]) margins[device] = {};
                margins[device][property] = value;
                
                this.margins.set(id, margins);
                this.saveToLocalStorage();
            }
            
            applyDeviceMargins(device) {
                this.margins.forEach((margins, id) => {
                    const element = document.querySelector(`[data-margin-id="${id}"]`);
                    if (element && margins[device]) {
                        Object.entries(margins[device]).forEach(([property, value]) => {
                            element.style[property] = value;
                        });
                    }
                });
            }
            
            generateId() {
                return 'margin-' + Date.now() + '-' + Math.random().toString(36).substr(2, 9);
            }
            
            saveToLocalStorage() {
                const data = Array.from(this.margins.entries());
                localStorage.setItem('comfycms_margins', JSON.stringify(data));
            }
            
            loadFromLocalStorage() {
                const data = localStorage.getItem('comfycms_margins');
                if (data) {
                    this.margins = new Map(JSON.parse(data));
                }
            }
        }
        
        // Initialiser l'application
        const comfyCMS = new ComfyCMS();
    </script>
</body>
</html>
